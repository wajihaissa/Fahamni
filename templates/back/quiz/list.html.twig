{% extends 'base.html.twig' %}

{% block title %}Quiz - FAHIMNI Admin{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root{
            --bg:#f8fafc;--card:#ffffff;--muted:#6b7280;--text-primary:#0b1220;--border:#e5e7eb;--primary:#6c5ce7;--primary-grad:linear-gradient(90deg,#7c6cff 0%,#6c5ce7 100%);--primary-gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);--radius:12px;--shadow:0 6px 18px rgba(11,18,32,0.06);--sidebar-width:280px;
        }
        body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;background:var(--bg);color:var(--muted)}
        .main-content{margin-left:var(--sidebar-width);min-height:100vh;}
        .admin-container{max-width:1200px;margin:0 auto;padding:2rem;}

        .page-header{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:1rem;margin-bottom:1.4rem;}
        .page-header h1{font-size:1.75rem;font-weight:700;color:var(--text-primary);margin:0 0 0.25rem 0;}
        .page-header p{font-size:0.95rem;color:var(--muted);margin:0;}

        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:0.9rem;margin-bottom:1.2rem;}
        .stat-card{background:var(--card);border-radius:var(--radius);border:1px solid var(--border);padding:1rem;box-shadow:var(--shadow);}
        .stat-title{font-size:0.78rem;color:#64748b;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:0.4rem;}
        .stat-value{font-size:1.35rem;font-weight:700;color:var(--text-primary);line-height:1.1;}

        .toolbar{display:flex;gap:0.7rem;align-items:center;flex-wrap:wrap;margin-bottom:1rem;}
        .search-form{display:flex;gap:0.55rem;align-items:center;flex:1;min-width:280px;}
        .search-input{flex:1;padding:0.65rem 0.85rem;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--text-primary);}
        .search-input:focus{outline:none;border-color:#8b7df0;box-shadow:0 0 0 3px rgba(124,108,255,0.12);}

        .btn{padding:0.55rem 0.95rem;border:none;border-radius:8px;font-weight:600;font-size:0.9rem;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px;}
        .btn-primary{background:var(--primary-grad);color:#fff;}
        .btn-secondary{background:#fff;color:#334155;border:1px solid var(--border);}
        .btn-danger{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;}
        .btn:hover{transform:translateY(-1px);}

        .quizzes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:1rem;}
        .quiz-card{background:var(--card);border-radius:var(--radius);border:1px solid var(--border);padding:1rem;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:0.9rem;}
        .quiz-card-header{display:flex;align-items:flex-start;gap:12px;}
        .quiz-icon{width:45px;height:45px;background:var(--primary-grad);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.1rem;flex-shrink:0;}
        .quiz-title{font-size:1.06rem;font-weight:700;color:var(--text-primary);margin:0;}
        .quiz-meta{font-size:0.85rem;color:var(--muted);margin-top:4px;}
        .quiz-actions{display:flex;gap:0.45rem;flex-wrap:wrap;}

        .empty-state{text-align:center;padding:2.5rem;background:var(--card);border-radius:var(--radius);border:1px solid var(--border);}
        .empty-state h3{font-size:1.15rem;font-weight:600;color:var(--text-primary);margin-bottom:0.45rem;}
        .empty-state p{color:var(--muted);margin:0;}

        @media (max-width: 900px){
            .main-content{margin-left:0;}
            .admin-container{padding:1rem;}
        }
    </style>
{% endblock %}

{% block body %}
    {% include 'back/_sidebar.html.twig' %}
    <div class="main-content">
        {% include 'back/_admin_navbar.html.twig' %}
        <div class="admin-container">
            {% for message in app.flashes('success') %}
                <div style="background:#dcfce7;color:#166534;border:1px solid #bbf7d0;padding:0.75rem 0.9rem;border-radius:10px;margin-bottom:0.8rem;">{{ message }}</div>
            {% endfor %}
            {% for message in app.flashes('error') %}
                <div style="background:#fee2e2;color:#991b1b;border:1px solid #fecaca;padding:0.75rem 0.9rem;border-radius:10px;margin-bottom:0.8rem;">{{ message }}</div>
            {% endfor %}

            <div class="page-header">
                <div>
                    <h1><i class="fas fa-question-circle" style="margin-right:0.5rem;"></i> Quiz</h1>
                    <p>Manage quizzes and track performance stats in one place.</p>
                </div>
                <a href="{{ path('admin_quiz_create') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Quiz
                </a>
            </div>

            <div class="stats-grid">
                <div class="stat-card"><div class="stat-title">Total Quizzes</div><div class="stat-value">{{ totalQuizzes }}</div></div>
                <div class="stat-card"><div class="stat-title">Created Today</div><div class="stat-value">{{ quizzesToday }}</div></div>
                <div class="stat-card"><div class="stat-title">Created This Week</div><div class="stat-value">{{ quizzesThisWeek }}</div></div>
                <div class="stat-card"><div class="stat-title">Total Questions</div><div class="stat-value">{{ totalQuestions }}</div></div>
                <div class="stat-card"><div class="stat-title">Total Attempts</div><div class="stat-value">{{ totalAttempts }}</div></div>
                <div class="stat-card"><div class="stat-title">Attempts Today</div><div class="stat-value">{{ todayAttempts }}</div></div>
                <div class="stat-card"><div class="stat-title">Pass Rate</div><div class="stat-value">{{ passRate }}%</div></div>
                <div class="stat-card"><div class="stat-title">Avg Score</div><div class="stat-value">{{ avgScore }}%</div></div>
                <div class="stat-card" style="grid-column: span 2;"><div class="stat-title">Most Taken Quiz</div><div class="stat-value" style="font-size:1rem;">{{ topQuizTitle }} ({{ topQuizAttempts }} attempts)</div></div>
            </div>

            <div class="toolbar">
                <form method="get" action="{{ path('admin_quiz_list') }}" class="search-form">
                    <input class="search-input" type="text" name="q" value="{{ search }}" placeholder="Search quizzes by title...">
                    <button class="btn btn-secondary" type="submit"><i class="fas fa-search"></i> Search</button>
                    {% if search is not empty %}
                        <a class="btn btn-secondary" href="{{ path('admin_quiz_list') }}">Clear</a>
                    {% endif %}
                </form>
            </div>

            {% if quizzes|length > 0 %}
            <div class="quizzes-grid">
                {% for quiz in quizzes %}
                <div class="quiz-card">
                    <div class="quiz-card-header">
                        <div class="quiz-icon"><i class="fas fa-book"></i></div>
                        <div>
                            <h3 class="quiz-title">{{ quiz.titre }}</h3>
                            <div class="quiz-meta">
                                <i class="fas fa-question-circle"></i> {{ quiz.questions|length }} question(s)
                                {% if quiz.createdAt is defined and quiz.createdAt %}
                                    <br><i class="fas fa-calendar"></i> {{ quiz.createdAt|date('Y-m-d H:i') }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="quiz-actions">
                        <a href="{{ path('admin_quiz_edit', {'id': quiz.id}) }}" class="btn btn-primary">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <form method="post" action="{{ path('admin_quiz_delete', {'id': quiz.id}) }}" onsubmit="return confirm('Delete this quiz? This action cannot be undone.');">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete_quiz_' ~ quiz.id) }}">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <h3>No quizzes found</h3>
                <p>{% if search is not empty %}No quiz matches "{{ search }}".{% else %}Create your first quiz with the button above.{% endif %}</p>
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}
