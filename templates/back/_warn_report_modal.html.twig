{# Modal partagé : envoi d'avertissement par email (conversation signalée). Utilisé depuis la page Alertes et depuis le modal de notification. #}
<style>
.warn-report-overlay{display:none;position:fixed;inset:0;background:rgba(11,18,32,0.45);backdrop-filter:blur(8px);z-index:2150;align-items:center;justify-content:center;padding:24px;}
.warn-report-overlay.is-open{display:flex;animation:warn-modal-fade 0.25s ease;}
.warn-report-modal{width:100%;max-width:580px;max-height:88vh;background:#fff;border-radius:20px;box-shadow:0 32px 64px rgba(11,18,32,0.2),0 0 0 1px rgba(255,255,255,0.5);overflow:hidden;display:flex;flex-direction:column;animation:warn-modal-slide 0.4s cubic-bezier(0.34,1.56,0.64,1);}
.warn-report-modal .modal-header{padding:20px 28px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:12px;background:#fff;}
.warn-report-modal .modal-header .header-icon{color:#d97706;font-size:1.25rem;}
.warn-report-modal .modal-header h3{margin:0;font-size:1.15rem;font-weight:700;color:#0b1220;}
.warn-report-modal .modal-body{padding:24px 28px;overflow-y:auto;flex:1;min-height:0;}
.warn-report-modal .warn-intro{color:#0b1220;font-size:0.95rem;line-height:1.6;margin-bottom:1.25rem;padding:14px 18px;background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);border-radius:12px;border-left:4px solid #667eea;}
.warn-report-modal .warn-intro strong{color:#4338ca;}
.warn-report-modal .warn-section-label{font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#6b7280;margin-bottom:8px;display:flex;align-items:center;gap:6px;}
.warn-report-modal .warn-section-label i{font-size:0.7rem;color:#d97706;}
.warn-report-modal .recipients-chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:1.25rem;}
.warn-report-modal .recipient-chip{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;font-size:0.8rem;color:#0b1220;box-shadow:0 1px 3px rgba(0,0,0,0.04);}
.warn-report-modal .recipient-chip i{color:#667eea;font-size:0.75rem;}
.warn-report-modal .email-preview-box{border-radius:14px;overflow:hidden;margin-bottom:0;border:1px solid #e2e8f0;box-shadow:0 4px 14px rgba(0,0,0,0.06);}
.warn-report-modal .email-preview-box .email-preview-label{padding:10px 16px;background:linear-gradient(180deg,#f8fafc 0%,#f1f5f9 100%);border-bottom:1px solid #e2e8f0;font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:#6b7280;}
.warn-report-modal .email-preview-box .email-subject{padding:14px 18px;background:#fff;border-bottom:1px solid #e2e8f0;font-size:0.9rem;font-weight:600;color:#0b1220;}
.warn-report-modal .email-preview-box .email-body{padding:18px;max-height:260px;overflow-y:auto;font-size:0.85rem;line-height:1.6;color:#0b1220;background:#fafafa;}
.warn-report-modal .email-preview-box .email-body *{max-width:100%;}
.warn-report-modal .modal-footer{padding:20px 28px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:12px;flex-shrink:0;background:#fafafa;}
.warn-report-modal .btn-cancel-warn{padding:12px 22px;border-radius:12px;font-size:0.9rem;font-weight:600;cursor:pointer;border:1px solid #e5e7eb;background:#fff;color:#0b1220;transition:background 0.2s,border-color 0.2s,box-shadow 0.2s;}
.warn-report-modal .btn-cancel-warn:hover{background:#f8fafc;border-color:#cbd5e1;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.warn-report-modal .btn-confirm-warn{padding:12px 22px;border-radius:12px;font-size:0.9rem;font-weight:600;cursor:pointer;border:none;background:linear-gradient(135deg,#d97706 0%,#b45309 100%);color:#fff;box-shadow:0 4px 14px rgba(217,119,6,0.35);transition:transform 0.2s,box-shadow 0.2s;}
.warn-report-modal .btn-confirm-warn:hover{box-shadow:0 6px 20px rgba(217,119,6,0.4);transform:translateY(-1px);}
.warn-report-modal .btn-confirm-warn:disabled{opacity:0.7;cursor:not-allowed;transform:none;}
.warn-report-modal .warn-loading{text-align:center;padding:40px 24px;color:#6b7280;}
.warn-report-modal .warn-loading i{font-size:1.75rem;display:block;margin-bottom:12px;animation:warn-spin 1s linear infinite;color:#d97706;}
@keyframes warn-spin{to{transform:rotate(360deg);}}
@keyframes warn-modal-fade{from{opacity:0;}to{opacity:1;}}
@keyframes warn-modal-slide{from{opacity:0;transform:scale(0.95);}to{opacity:1;transform:scale(1);}}
</style>
<div class="warn-report-overlay" id="warnReportOverlay" aria-hidden="true">
    <div class="warn-report-modal" id="warnReportModal" role="dialog" aria-labelledby="warnReportModalTitle">
        <div class="modal-header">
            <i class="fas fa-exclamation-triangle header-icon"></i>
            <h3 id="warnReportModalTitle">Envoyer un avertissement</h3>
        </div>
        <div class="modal-body">
            <div class="warn-loading" id="warnModalLoading"><i class="fas fa-spinner"></i> Chargement de l'aperçu…</div>
            <div id="warnModalContent" style="display: none;">
                <p class="warn-intro">Cette action enverra un <strong>email</strong> à chaque participant. Vérifiez l'aperçu ci-dessous avant d'envoyer.</p>
                <div class="warn-section-label"><i class="fas fa-users"></i> Destinataires</div>
                <div class="recipients-chips" id="warnRecipients"></div>
                <div class="warn-section-label"><i class="fas fa-envelope-open-text"></i> Aperçu du message</div>
                <div class="email-preview-box">
                    <div class="email-preview-label">Sujet</div>
                    <div class="email-subject" id="warnEmailSubject"></div>
                    <div class="email-preview-label" style="border-top: 1px solid #e2e8f0;">Corps du message</div>
                    <div class="email-body" id="warnEmailBody"></div>
                </div>
            </div>
            <div id="warnModalError" style="display: none;" class="text-muted"></div>
        </div>
        <div class="modal-footer" id="warnModalFooter" style="display: none;">
            <button type="button" class="btn-cancel-warn" id="warnModalCancel">Annuler</button>
            <form id="warnReportForm" method="post" action="" style="display: inline;">
                <input type="hidden" name="_token" id="warnReportToken" value="">
                <button type="submit" class="btn-confirm-warn" id="warnModalConfirm"><i class="fas fa-paper-plane" style="margin-right: 6px;"></i>Envoyer l'avertissement</button>
            </form>
        </div>
    </div>
</div>
<script>
(function() {
    var previewUrlTpl = "{{ path('admin_messenger_conversation_report_warn_preview', { id: 0 }) }}";
    var warnUrlTpl = "{{ path('admin_messenger_conversation_report_warn', { id: 0 }) }}";
    var tokenUrlTpl = "{{ path('admin_messenger_conversation_report_warn_token', { id: 0 }) }}";
    function urlForReport(baseUrl, reportId) {
        return baseUrl.replace(/\/report\/0\//, '/report/' + reportId + '/');
    }

    function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    window.openWarnReportModal = function(options) {
        var reportId = options.reportId;
        var previewUrl = options.previewUrl || urlForReport(previewUrlTpl, reportId);
        var warnUrl = options.warnUrl || urlForReport(warnUrlTpl, reportId);
        var warnToken = options.warnToken;

        var overlay = document.getElementById('warnReportOverlay');
        var loading = document.getElementById('warnModalLoading');
        var content = document.getElementById('warnModalContent');
        var errorEl = document.getElementById('warnModalError');
        var footer = document.getElementById('warnModalFooter');
        var form = document.getElementById('warnReportForm');
        var tokenInput = document.getElementById('warnReportToken');
        var confirmBtn = document.getElementById('warnModalConfirm');

        if (!overlay || !form || !tokenInput) return;

        form.action = warnUrl;
        content.style.display = 'none';
        errorEl.style.display = 'none';
        footer.style.display = 'none';
        loading.style.display = 'block';
        overlay.classList.add('is-open');
        overlay.setAttribute('aria-hidden', 'false');

        function showContent(data) {
            loading.style.display = 'none';
            if (data.error) {
                errorEl.textContent = data.error;
                errorEl.style.display = 'block';
                return;
            }
            var recipients = data.recipients || [];
            var recipientsEl = document.getElementById('warnRecipients');
            var subjectEl = document.getElementById('warnEmailSubject');
            var bodyEl = document.getElementById('warnEmailBody');
            if (recipients.length === 0) {
                recipientsEl.innerHTML = '<span class="recipient-chip" style="color: var(--muted);">Aucun destinataire</span>';
            } else {
                recipientsEl.innerHTML = recipients.map(function(r) {
                    var name = escapeHtml(r.fullName || r.email);
                    var email = escapeHtml(r.email);
                    return '<span class="recipient-chip"><i class="fas fa-user"></i><span>' + name + ' <small style="color: var(--muted); font-size: 0.75rem;">' + email + '</small></span></span>';
                }).join('');
            }
            subjectEl.textContent = data.subject || '';
            bodyEl.innerHTML = data.bodyHtml || '';
            content.style.display = 'block';
            footer.style.display = 'flex';
            tokenInput.value = warnToken || '';
        }

        function doOpen() {
            fetch(previewUrl, { headers: { 'Accept': 'application/json' } })
                .then(function(r) { return r.json(); })
                .then(showContent)
                .catch(function() {
                    loading.style.display = 'none';
                    errorEl.textContent = 'Impossible de charger l\'aperçu.';
                    errorEl.style.display = 'block';
                });
        }

        if (warnToken) {
            tokenInput.value = warnToken;
            doOpen();
        } else {
            fetch(urlForReport(tokenUrlTpl, reportId), { headers: { 'Accept': 'application/json' } })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    warnToken = data.token || '';
                    tokenInput.value = warnToken;
                    doOpen();
                })
                .catch(function() {
                    loading.style.display = 'none';
                    errorEl.textContent = 'Impossible de charger le token.';
                    errorEl.style.display = 'block';
                });
        }
    };

    var overlay = document.getElementById('warnReportOverlay');
    var cancelBtn = document.getElementById('warnModalCancel');
    var form = document.getElementById('warnReportForm');
    var tokenInput = document.getElementById('warnReportToken');
    var confirmBtn = document.getElementById('warnModalConfirm');

    if (overlay) overlay.addEventListener('click', function(e) { if (e.target === overlay) { overlay.classList.remove('is-open'); overlay.setAttribute('aria-hidden', 'true'); } });
    if (cancelBtn) cancelBtn.addEventListener('click', function() { if (overlay) { overlay.classList.remove('is-open'); overlay.setAttribute('aria-hidden', 'true'); } });

    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (confirmBtn) confirmBtn.disabled = true;
            var body = new FormData();
            body.append('_token', tokenInput ? tokenInput.value : '');
            fetch(form.action, { method: 'POST', body: body, headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (overlay) { overlay.classList.remove('is-open'); overlay.setAttribute('aria-hidden', 'true'); }
                    if (data.ok && data.message) alert(data.message);
                    else if (data.error) alert(data.error);
                    if (confirmBtn) confirmBtn.disabled = false;
                    if (data.ok) window.location.reload();
                })
                .catch(function() {
                    if (confirmBtn) confirmBtn.disabled = false;
                    alert('Erreur lors de l\'envoi.');
                });
        });
    }
})();
</script>
