<style>
    .sidebar-badge {
        min-width: 22px;
        height: 22px;
        border-radius: 11px;
        font-size: 11px;
        font-weight: 700;
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 6px;
        margin-left: auto;
        line-height: 1;
        animation: badgePop 0.4s cubic-bezier(.34,1.56,.64,1);
        position: relative;
    }
    /* Etat actif : il y a des elements a traiter */
    .sidebar-badge.has-items {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
    }
    .sidebar-badge.has-items.articles-badge {
        background: linear-gradient(135deg, #f59e0b, #ef4444);
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.5);
    }
    /* Etat vide : tout est OK */
    .sidebar-badge.empty {
        background: rgba(16, 185, 129, 0.25);
        color: rgba(255,255,255,0.7);
        box-shadow: none;
        font-size: 10px;
    }
    @keyframes badgePop {
        0% { transform: scale(0); opacity: 0; }
        60% { transform: scale(1.2); }
        100% { transform: scale(1); opacity: 1; }
    }
    /* Pulse uniquement quand il y a des items */
    .sidebar-badge.has-items::after {
        content: '';
        position: absolute;
        inset: -3px;
        border-radius: 14px;
        animation: badgePulse 2s ease infinite;
    }
    .sidebar-badge.has-items.articles-badge::after {
        box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
    }
    .sidebar-badge.has-items.comments-badge::after {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
    }
    @keyframes badgePulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.15); opacity: 0.7; }
    }
</style>

<aside class="sidebar">
    <div class="sidebar-header">
        <div class="logo">
            <h2>FAHIMNI</h2>
            <div class="brand-sub">Admin</div>
        </div>
    </div>

    <div class="admin-profile">
        <div style="display:flex;align-items:center;gap:10px">
            <div class="avatar">
                {%- set name = app.user.fullName|default(app.user.username|default('A')) -%}
                {%- set parts = name|split(' ') -%}
                <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">
                    {%- if parts|length >= 2 -%}{{ parts[0][0:1]|upper }}{{ parts[1][0:1]|upper }}{%- else -%}{{ name[0:1]|upper }}{%- endif -%}
                </div>
            </div>
            <div class="admin-info">
                <h4>{{ app.user.fullName|default(app.user.username|default('Admin')) }}</h4>
                <p>Administrator</p>
            </div>
        </div>
    </div>

    {% set current_route = app.request.get('_route') ?? '' %}
    <ul class="sidebar-nav">
        <li class="{% if current_route == 'admin_dashboard' %}active{% endif %}"><a href="{{ path('admin_dashboard') }}"><i class="fas fa-tachometer-alt"></i><span class="label">Dashboard</span></a></li>
        <li class="{% if current_route starts with 'admin_users_' %}active{% endif %}"><a href="{{ path('admin_users_index') }}"><i class="fas fa-users"></i><span class="label">Users</span></a></li>
        <li class="{% if current_route starts with 'admin_messenger_' %}active{% endif %}"><a href="{{ path('admin_messenger_index') }}"><i class="fas fa-comments"></i><span class="label">Messagerie</span></a></li>
        <li class="{% if current_route == 'admin_articles' %}active{% endif %}">
            <a href="{{ path('admin_articles') }}">
                <i class="fas fa-newspaper"></i>
                <span class="label">Articles</span>
                <span class="sidebar-badge articles-badge empty" id="sidebarArticlesBadge">0</span>
            </a>
        </li>
        <li class="{% if current_route == 'admin_comments' %}active{% endif %}">
            <a href="{{ path('admin_comments') }}">
                <i class="fas fa-shield-alt"></i>
                <span class="label">Commentaires</span>
                <span class="sidebar-badge comments-badge empty" id="sidebarCommentsBadge">0</span>
            </a>
        </li>
        <li class="{% if current_route starts with 'admin_quiz_' %}active{% endif %}"><a href="{{ path('admin_quiz_list') }}"><i class="fas fa-question-circle"></i><span class="label">Quiz</span></a></li>
        <li class="{% if current_route == 'admin_statistics' %}active{% endif %}"><a href="{{ path('admin_statistics') }}"><i class="fas fa-chart-bar"></i><span class="label">Statistics</span></a></li>
        <li><a href="{{ path('app_logout') }}"><i class="fas fa-sign-out-alt"></i><span class="label">Logout</span></a></li>
    </ul>
</aside>

<script>
(function() {
    var articlesBadge = document.getElementById('sidebarArticlesBadge');
    var commentsBadge = document.getElementById('sidebarCommentsBadge');

    function updateBadge(badge, count) {
        badge.textContent = count > 99 ? '99+' : count;
        if (count > 0) {
            badge.classList.remove('empty');
            badge.classList.add('has-items');
        } else {
            badge.classList.remove('has-items');
            badge.classList.add('empty');
        }
    }

    function fetchCounts() {
        fetch('{{ path('admin_articles_pending_count') }}', { credentials: 'same-origin' })
            .then(function(r) { return r.json(); })
            .then(function(data) { updateBadge(articlesBadge, data.count || 0); })
            .catch(function() {});

        fetch('{{ path('admin_comments_count') }}', { credentials: 'same-origin' })
            .then(function(r) { return r.json(); })
            .then(function(data) { updateBadge(commentsBadge, data.count || 0); })
            .catch(function() {});
    }

    fetchCounts();
    setInterval(fetchCounts, 30000);
})();
</script>
