{# Message Item Modernis√© - Un message dans le fil de conversation avec avatar et bulles modernes #}
{% set emoji_map = { 0: 'üëç', 1: '‚ù§Ô∏è', 2: 'üòÇ', 3: 'üòÆ', 4: 'üò¢', 5: 'üò°' } %}
{% set is_deleted = msg.deletedAt is not null %}

<div class="message-section{{ is_mine ? ' you' : ' other' }}{{ is_deleted ? ' message-deleted' : '' }}" data-message-id="{{ msg.id }}">
    {# Avatar pour les messages des autres #}
    {% if not is_mine %}
        <div class="message-avatar">
            {# Si vous avez des images d'avatar : <img src="{{ msg.sender.avatarUrl }}" alt=""> #}
            {{ msg.sender.FullName|slice(0,2)|upper }}
        </div>
    {% endif %}
    
    <div class="message-row">
        <div class="message-bubble-wrap">
            {# Nom de l'exp√©diteur (seulement pour les autres) #}
            {% if not is_mine %}
                <div class="message-sender">{{ msg.sender.FullName }}</div>
            {% endif %}
            
            {# Citation du message auquel on r√©pond #}
            {% if msg.replyTo %}
                <div class="message-reply-quote">
                    <div class="reply-quote-author">{{ msg.replyTo.sender.FullName }}</div>
                    <div class="reply-quote-text">
                        {% if msg.replyTo.deletedAt %}
                            Ce message a √©t√© supprim√©
                        {% else %}
                            {{ msg.replyTo.content|slice(0, 80) }}{% if msg.replyTo.content|length > 80 %}‚Ä¶{% endif %}
                        {% endif %}
                    </div>
                </div>
            {% endif %}
            
            {# Contenu du message avec actions #}
            <div class="message-content-row">
                {% if not is_deleted %}
                {# Actions du message (masqu√©es si message supprim√©) #}
                <div class="message-actions">
                    {# Menu kebab #}
                    <div class="kebab-wrap">
                        <button type="button" class="message-action-btn kebab-btn" title="Menu" aria-haspopup="true">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="kebab-dropdown">
                            <div class="dropdown-time">
                                Envoy√© {{ msg.createdAt|date('d/m/Y') }} √† {{ msg.createdAt|date('H:i') }}
                            </div>
                            
                            <button type="button" class="dropdown-item dropdown-transfer" title="Transf√©rer" data-transfer-msg-id="{{ msg.id }}">
                                <i class="fas fa-share-alt" style="margin-right:8px;width:16px;"></i>Transf√©rer
                            </button>
                            
                            <button type="button" class="dropdown-item dropdown-copy" data-copy-text="{{ msg.content|e('html_attr') }}">
                                <i class="fas fa-copy" style="margin-right:8px;width:16px;"></i>Copier
                            </button>
                            
                            {% if is_mine %}
                                <a href="{{ path('app_messenger_edit_message', { convId: current_conversation.id, messageId: msg.id }) }}" class="dropdown-item">
                                    <i class="fas fa-edit" style="margin-right:8px;width:16px;"></i>Modifier
                                </a>
                                
                                <form method="post" action="{{ path('app_messenger_delete_message', { convId: current_conversation.id, messageId: msg.id }) }}" onsubmit="return confirm('Supprimer ce message ?');" class="d-inline" style="display:block !important;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete_msg_' ~ msg.id) }}">
                                    <button type="submit" class="dropdown-item danger" style="width:100%;">
                                        <i class="fas fa-trash-alt" style="margin-right:8px;width:16px;"></i>Retirer
                                    </button>
                                </form>
                            {% else %}
                                <button type="button" class="dropdown-item dropdown-signal dropdown-signal-message{% if message_already_reported|default(false) %} message-already-reported{% endif %}" title="{{ message_already_reported|default(false) ? 'Vous avez d√©j√† signal√© ce message' : 'Signaler ce message' }}" data-conv-id="{{ current_conversation.id }}" data-message-id="{{ msg.id }}">
                                    <i class="fas fa-flag" style="margin-right:8px;width:16px;"></i>Signaler ce message
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    {# Bouton r√©pondre #}
                    <button type="button" class="message-action-btn msg-reply" 
                            data-reply-id="{{ msg.id }}" 
                            data-reply-author="{{ (msg.sender.FullName)|e('html_attr') }}" 
                            data-reply-text="{{ msg.content|slice(0, 60)|e('html_attr') }}{% if msg.content|length > 60 %}‚Ä¶{% endif %}" 
                            title="R√©pondre">
                        <i class="fas fa-reply"></i>
                    </button>
                    
                    {# Bouton emoji avec picker #}
                    <div class="message-action-btn emoji-btn" title="R√©agir" data-msg-id="{{ msg.id }}">
                        <i class="far fa-smile"></i>
                        <div class="emoji-picker" data-msg-id="{{ msg.id }}">
                            {% for emojiKey, emojiChar in emoji_map %}
                                {% set reactionsForEmoji = msg.reactions|filter(r => r.emoji == emojiKey) %}
                                {% set myReaction = reactionsForEmoji|filter(r => r.reactor.id == actor.id)|first %}
                                {% if myReaction %}
                                    <form method="post" action="{{ path('app_messenger_remove_reaction', { convId: current_conversation.id, reactionId: myReaction.id }) }}" class="d-inline">
                                        <input type="hidden" name="_token" value="{{ csrf_token('remove_reaction_' ~ myReaction.id) }}">
                                        <button type="submit" class="emoji-option" title="Retirer">{{ emojiChar }}</button>
                                    </form>
                                {% else %}
                                    <form method="post" action="{{ path('app_messenger_add_reaction', { convId: current_conversation.id, messageId: msg.id }) }}" class="d-inline">
                                        <input type="hidden" name="_token" value="{{ csrf_token('reaction_' ~ msg.id ~ '_' ~ emojiKey) }}">
                                        <input type="hidden" name="emoji" value="{{ emojiKey }}">
                                        <button type="submit" class="emoji-option" title="{{ emojiChar }}">{{ emojiChar }}</button>
                                    </form>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {# Bulle du message (masqu√©e si contenu vide et pi√®ces jointes uniquement) #}
                {% if is_deleted %}
                <div class="message-content">
                    <span class="message-deleted-text">Ce message a √©t√© supprim√©</span>
                </div>
                {% elseif (msg.content|trim)|length > 0 %}
                <div class="message-content">
                    {{ msg.content }}
                </div>
                {% endif %}
                {% if not is_deleted and msg.attachments|length > 0 %}
                <div class="message-attachments">
                    {% for att in msg.attachments %}
                        {% if att.isImage %}
                            {% set _inline = attachment_inline_srcs|default({}) %}
                            {% set img_src = _inline[att.id]|default(path('app_messenger_attachment', { id: att.id })) %}
                            <a href="{{ path('app_messenger_attachment', { id: att.id }) }}" target="_blank" rel="noopener" class="message-attachment message-attachment-image">
                                <img src="{{ img_src }}" alt="{{ att.originalName }}" loading="eager" decoding="async">
                            </a>
                        {% else %}
                            <a href="{{ path('app_messenger_attachment', { id: att.id }) }}" class="message-attachment message-attachment-file" download="{{ att.originalName }}">
                                <i class="fas fa-file-alt"></i> {{ att.originalName }}
                            </a>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            {% if not is_deleted %}
            {# Footer avec r√©actions (masqu√© si message supprim√©) #}
            <div class="message-footer">
                {# R√©actions existantes #}
                <div class="message-reactions">
                    {% for emojiKey, emojiChar in emoji_map %}
                        {% set reactionsForEmoji = msg.reactions|filter(r => r.emoji == emojiKey) %}
                        {% set myReaction = reactionsForEmoji|filter(r => r.reactor.id == actor.id)|first %}
                        {% if reactionsForEmoji|length > 0 %}
                            {% if myReaction %}
                                <form method="post" action="{{ path('app_messenger_remove_reaction', { convId: current_conversation.id, reactionId: myReaction.id }) }}" class="d-inline" style="display:inline;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('remove_reaction_' ~ myReaction.id) }}">
                                    <button type="submit" class="reaction-pill reaction-pill-mine" title="Cliquer pour retirer">
                                        <span class="reaction-emoji">{{ emojiChar }}</span>
                                        <span class="reaction-count">{{ reactionsForEmoji|length }}</span>
                                    </button>
                                </form>
                            {% else %}
                                <span class="reaction-pill" title="{{ reactionsForEmoji|map(r => r.reactor.FullName)|join(', ') }}">
                                    <span class="reaction-emoji">{{ emojiChar }}</span>
                                    <span class="reaction-count">{{ reactionsForEmoji|length }}</span>
                                </span>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
                
            </div>
            {% endif %}
        </div>
    </div>
</div>
