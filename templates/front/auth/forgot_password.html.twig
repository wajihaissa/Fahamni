{% extends 'front/base_front.html.twig' %}

{% block title %}Forgot Password - FAHIMNI{% endblock %}

{% block content %}
    <main class="auth-main">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>Reset Password</h1>
                    <p>Enter your email to receive a 6-digit verification code</p>
                </div>

                {% for type, messages in app.flashes %}
                    {% for message in messages %}
                        <div class="alert alert-{{ type }}" style="margin-bottom:1rem;padding:12px;border-radius:8px;{% if type == 'error' %}background:#fee2e2;color:#991b1b;border:1px solid #fecaca;{% else %}background:#d1fae5;color:#065f46;border:1px solid #a7f3d0;{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endfor %}

                <form class="auth-form" id="forgotForm" method="post" action="{{ path('app_forgot_password') }}">
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" placeholder="Enter your email" value="{{ app.request.query.get('email') }}" required>
                        <span class="error-message" id="emailError"></span>
                    </div>
                    <div class="form-group">
                        {% if recaptcha_site_key is empty %}
                            <div class="alert alert-danger" style="padding:12px;border-radius:8px;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;">
                                reCAPTCHA is not configured. Add `RECAPTCHA_SITE_KEY` and `RECAPTCHA_SECRET_KEY` in `.env.local`.
                            </div>
                        {% else %}
                            <div class="g-recaptcha" data-sitekey="{{ recaptcha_site_key }}"></div>
                        {% endif %}
                        <span class="error-message" id="captchaError"></span>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full">Send Verification Code</button>
                </form>

                <div class="auth-footer">
                    <p>Remember your password? <a href="/login">Sign in here</a></p>
                </div>
            </div>

            <div class="auth-side">
                <div class="auth-side-content">
                    <h2>Password Security</h2>
                    <p>We will send a short verification code to your email address.</p>
                    <div class="auth-features">
                        <div class="auth-feature">
                            <span class="feature-icon">OK</span>
                            <span>6-digit verification code</span>
                        </div>
                        <div class="auth-feature">
                            <span class="feature-icon">OK</span>
                            <span>Code expires in 15 minutes</span>
                        </div>
                        <div class="auth-feature">
                            <span class="feature-icon">OK</span>
                            <span>Secure password update</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var forgotForm = document.getElementById('forgotForm');
            var emailInput = document.getElementById('email');
            var emailError = document.getElementById('emailError');
            var captchaError = document.getElementById('captchaError');

            function isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }

            if (forgotForm) {
                forgotForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    emailError.textContent = '';
                    captchaError.textContent = '';

                    var email = emailInput.value.trim();
                    if (!email) {
                        emailError.textContent = 'Email is required';
                        return;
                    } else if (!isValidEmail(email)) {
                        emailError.textContent = 'Please enter a valid email address';
                        return;
                    }

                    const submitBtn = forgotForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'Sending...';
                    submitBtn.disabled = true;

                    const formData = new FormData(forgotForm);
                    formData.set('email', email);

                    fetch('{{ path('app_forgot_password') }}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                    .then(async response => {
                        const contentType = response.headers.get('content-type') || '';
                        const data = contentType.includes('application/json')
                            ? await response.json()
                            : { success: false, message: 'Unexpected server response. Please refresh and try again.' };
                        return { ok: response.ok, data: data };
                    })
                    .then(result => {
                        const data = result.data;
                        if (data.success && data.redirect) {
                            window.location.href = data.redirect;
                            return;
                        }

                        emailError.textContent = data.message || 'An error occurred';
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        if (typeof grecaptcha !== 'undefined') {
                            grecaptcha.reset();
                        }
                    })
                    .catch(error => {
                        emailError.textContent = 'Network error: ' + error.message;
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        if (typeof grecaptcha !== 'undefined') {
                            grecaptcha.reset();
                        }
                    });
                });
            }
        });
    </script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
{% endblock %}
