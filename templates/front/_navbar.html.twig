    <!-- Navbar Partial -->
    <header>
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">FAHIM<span>NI</span></a>
                
                <nav>
                    <ul>
                        <li><a href="/home" class="nav-link{{ (current_page|default('')) == 'home' ? ' active' : '' }}" data-page="home">Home</a></li>
                        <li><a href="/articles" class="nav-link{{ (current_page|default('')) == 'articles' ? ' active' : '' }}" data-page="articles">Articles</a></li>
                        <li><a href="/tutor" class="nav-link{{ (current_page|default('')) == 'tutors' ? ' active' : '' }}" data-page="tutors">Find Tutors</a></li>
                        <li><a href="/calendar" class="nav-link{{ (current_page|default('')) == 'calendar' ? ' active' : '' }}" data-page="calendar">Calendar</a></li>
                        <li><a href="{{ path('app_quiz_list') }}" class="nav-link{{ (current_page|default('')) == 'quiz' ? ' active' : '' }}" data-page="quiz">Quiz</a></li>
                        <li><a href="/messenger" class="nav-link{{ (current_page|default('')) == 'messenger' ? ' active' : '' }}" data-page="messenger">Messenger</a></li>
                    </ul>
                </nav>
                
                <div class="auth-buttons">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>

                    {% set user = app.session.get('user') %}
                    {% set userRoles = user ? (user.roles|default([])) : [] %}
                    {% set canAccessAdmin = 'ROLE_ADMIN' in userRoles or 'ROLE_SUPER_ADMIN' in userRoles %}
                    {% if user %}
                    {# Icône Messenger : ouvre la Chat Sidebar #}
                    <button type="button" class="navbar-messenger-icon-btn" id="navbarMessengerIconBtn" aria-label="Ouvrir les messages">
                        <i class="fas fa-comments"></i>
                    </button>
                    {% endif %}

                    {% if user %}
                    <!-- User Profile Dropdown -->
                    <div class="user-dropdown" style="position: relative;">
                        <button class="user-profile-btn" id="userProfileBtn" style="background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 20px; background: var(--primary-color); color: white; font-weight: 500;">
                            <div style="width: 32px; height: 32px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--primary-color);">
                                {{ user.fullName|first|upper }}
                            </div>
                            <span>{{ user.fullName }}</span>
                            <i class="fas fa-chevron-down" style="font-size: 12px;"></i>
                        </button>
                        
                        <div class="dropdown-menu" id="userDropdown" style="position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000; display: none; margin-top: 8px;">
                            <div style="padding: 12px 16px; border-bottom: 1px solid var(--border-color);">
                                <p style="margin: 0; font-weight: 600; color: var(--text-color);">{{ user.fullName }}</p>
                                <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-light);">{{ user.email }}</p>
                            </div>
                            <a href="/profile" style="display: block; padding: 12px 16px; color: var(--text-color); text-decoration: none; border-bottom: 1px solid var(--border-color);" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
                                <i class="fas fa-user" style="margin-right: 8px; color: var(--primary-color);"></i> My Profile
                            </a>
                            <a href="/settings" style="display: block; padding: 12px 16px; color: var(--text-color); text-decoration: none; border-bottom: 1px solid var(--border-color);" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
                                <i class="fas fa-cog" style="margin-right: 8px; color: var(--primary-color);"></i> Settings
                            </a>
                            {% if canAccessAdmin %}
                            <a href="{{ path('admin_dashboard') }}" style="display: block; padding: 12px 16px; color: var(--text-color); text-decoration: none; border-bottom: 1px solid var(--border-color);" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
                                <i class="fas fa-shield-alt" style="margin-right: 8px; color: var(--primary-color);"></i> Admin
                            </a>
                            {% endif %}
                            <a href="/logout" style="display: block; padding: 12px 16px; color: #d32f2f; text-decoration: none;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
                                <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i> Logout
                            </a>
                        </div>
                    </div>

                    <script>
                        document.getElementById('userProfileBtn').addEventListener('click', function(e) {
                            e.stopPropagation();
                            var dropdown = document.getElementById('userDropdown');
                            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                        });
                        document.addEventListener('click', function(e) {
                            var dropdown = document.getElementById('userDropdown');
                            var userDropdown = document.querySelector('.user-dropdown');
                            if (!userDropdown.contains(e.target)) {
                                dropdown.style.display = 'none';
                            }
                        });
                    </script>

                    {# Styles Messenger : pour le widget flottant. Sur la page /messenger ils sont déjà dans le head (block stylesheets), on ne les charge pas ici pour éviter double application qui casse le scroll. #}
                    {% if current_page|default('') != 'messenger' %}
                    <style id="messenger-float-styles">{% include 'front/messenger/_messenger_styles.html.twig' %}</style>
                    {% endif %}
                    {# Chat Sidebar (liste des conversations) - visible uniquement si user connecté #}
                    <div class="navbar-chat-sidebar-overlay" id="navbarChatSidebarOverlay" aria-hidden="true"></div>
                    <div class="navbar-chat-sidebar" id="navbarChatSidebar" aria-hidden="true">
                        <div class="navbar-chat-sidebar-top">
                            <h2>Messenger</h2>
                            <div class="navbar-chat-sidebar-top-actions">
                                <a href="{{ path('app_messenger_index') }}" class="navbar-chat-sidebar-head-btn" data-tooltip="Voir tout dans Messenger" aria-label="Voir tout dans Messenger"><i class="fas fa-external-link-alt"></i></a>
                                <button type="button" class="navbar-chat-sidebar-head-btn" id="navbarChatSidebarNewMsgBtn" data-tooltip="Nouveau message" aria-label="Nouveau message"><i class="fas fa-pen"></i></button>
                                <button type="button" class="navbar-chat-sidebar-close" id="navbarChatSidebarClose" data-tooltip="Fermer" aria-label="Fermer"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <div class="navbar-chat-sidebar-content" id="navbarChatSidebarContent">
                            <div class="navbar-chat-sidebar-loading" id="navbarChatSidebarLoading"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>
                        </div>
                        <div class="navbar-chat-sidebar-new-panel" id="navbarChatSidebarNewPanel" style="display:none;">
                            <div class="navbar-chat-sidebar-new-panel-back">
                                <button type="button" class="navbar-chat-sidebar-back-btn" id="navbarChatSidebarBackFromNew"><i class="fas fa-arrow-left"></i> Retour</button>
                            </div>
                            <div class="navbar-chat-sidebar-new-panel-search">
                                <i class="fas fa-search"></i>
                                <input type="text" id="navbarChatSidebarUserSearch" placeholder="Rechercher un utilisateur..." autocomplete="off">
                            </div>
                            <div class="navbar-chat-sidebar-new-panel-results" id="navbarChatSidebarUserResults"></div>
                        </div>
                        <div class="navbar-chat-sidebar-reduced" id="navbarChatSidebarReduced" style="display:none;">
                            <div class="navbar-chat-sidebar-reduced-header">
                                <button type="button" class="navbar-chat-sidebar-back-btn" id="navbarChatSidebarBackFromReduced"><i class="fas fa-arrow-left"></i> Retour</button>
                            </div>
                            <iframe id="navbarChatSidebarIframe" class="navbar-chat-sidebar-iframe" title="Conversation"></iframe>
                        </div>
                    </div>
                    {# Fenêtre flottante type Messenger : conversation en mode réduit après clic dans le panel #}
                    <div class="messenger-float-root" id="messengerFloatRoot" aria-hidden="true" data-summary-url-template="{{ path('app_messenger_summary', { id: 0 }) }}">
                        <div class="messenger-float-widget" id="messengerFloatWidget">
                            <div class="messenger-float-header">
                                <div class="messenger-float-header-info">
                                    <div class="messenger-float-avatar" id="messengerFloatAvatar">?</div>
                                    <div class="messenger-float-title" id="messengerFloatTitle">Conversation</div>
                                </div>
                                <div class="messenger-float-actions">
                                    <button type="button" class="messenger-float-btn messenger-float-summary" id="messengerFloatSummaryBtn" aria-label="Résumer la conversation" title="Résumer la conversation"><i class="fas fa-file-alt"></i></button>
                                    <button type="button" class="messenger-float-btn messenger-float-minimize" id="messengerFloatMinimize" aria-label="Réduire"><i class="fas fa-minus"></i></button>
                                    <button type="button" class="messenger-float-btn messenger-float-close" id="messengerFloatClose" aria-label="Fermer"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                            <div class="messenger-float-body" id="messengerFloatBody">
                                <div class="messenger-float-loading" id="messengerFloatLoading">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement...
                                </div>
                            </div>
                        </div>
                    </div>
                    {# Modals pour le mode réduit : transfert (contenu chargé en AJAX) + confirmation suppression + résumé #}
                    <div id="messengerFloatModalsWrap">
                        <div id="messengerFloatDropdownPortal" aria-hidden="true"></div>
                        <div id="messengerFloatTransferModalContainer"></div>
                        <div class="summary-conv-modal-overlay float-summary-modal-overlay" id="floatSummaryModalOverlay" aria-hidden="true" data-summary-url="">
                            <div class="summary-conv-modal" id="floatSummaryModal" role="dialog" aria-labelledby="floatSummaryModalTitle">
                                <div class="summary-conv-modal-header">
                                    <div class="summary-conv-modal-header-icon"><i class="fas fa-file-alt"></i></div>
                                    <h2 class="summary-conv-modal-title" id="floatSummaryModalTitle">Résumé de la conversation</h2>
                                    <p class="summary-conv-modal-subtitle">Résumé généré par IA à partir des messages.</p>
                                    <button type="button" class="summary-conv-modal-close" id="floatSummaryModalClose" aria-label="Fermer"><i class="fas fa-times"></i></button>
                                </div>
                                <div class="summary-conv-modal-body">
                                    <div class="summary-conv-loading" id="floatSummaryLoading">
                                        <div class="summary-conv-spinner"></div>
                                        <p class="summary-conv-loading-text">Génération du résumé en cours…</p>
                                        <p class="summary-conv-loading-hint">Cela peut prendre 5 à 15 secondes.</p>
                                    </div>
                                    <div class="summary-conv-content" id="floatSummaryContent" style="display: none;">
                                        <div class="summary-conv-text" id="floatSummaryText"></div>
                                        <p class="summary-conv-saved-hint"><i class="fas fa-check-circle"></i> Résumé enregistré.</p>
                                        <button type="button" class="summary-conv-btn summary-conv-btn-regenerate" id="floatSummaryRegenerate"><i class="fas fa-sync-alt"></i> Régénérer</button>
                                    </div>
                                    <div class="summary-conv-error" id="floatSummaryError" style="display: none;">
                                        <i class="fas fa-exclamation-triangle summary-conv-error-icon"></i>
                                        <p class="summary-conv-error-text" id="floatSummaryErrorText"></p>
                                        <p class="summary-conv-error-debug" id="floatSummaryErrorDebug"></p>
                                        <button type="button" class="summary-conv-btn summary-conv-btn-retry" id="floatSummaryRetry">Réessayer</button>
                                    </div>
                                    <div class="summary-conv-actions">
                                        <button type="button" class="summary-conv-btn summary-conv-btn-close" id="floatSummaryBtnClose">Fermer</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="float-delete-confirm-overlay" id="floatDeleteConfirmOverlay" aria-hidden="true">
                            <div class="float-delete-confirm-modal" id="floatDeleteConfirmModal">
                                <p class="float-delete-confirm-text">Supprimer ce message ?</p>
                                <div class="float-delete-confirm-actions">
                                    <button type="button" class="float-delete-confirm-btn float-delete-cancel" id="floatDeleteCancel">Annuler</button>
                                    <button type="button" class="float-delete-confirm-btn float-delete-submit" id="floatDeleteSubmit">Supprimer</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <style>
                        /* Hauteur navbar : sidebar et overlay démarrent en dessous (comme Facebook) */
                        header { --navbar-height: 72px; }
                        /* Tooltips personnalisés : apparition rapide (0.15s), style soigné */
                        [data-tooltip] { position: relative; }
                        [data-tooltip]::after { content: attr(data-tooltip); position: absolute; left: 50%; top: 100%; transform: translate(-50%, 8px); padding: 6px 10px; background: #374151; color: #fff; font-size: 0.75rem; font-weight: 500; white-space: nowrap; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; visibility: hidden; transition: opacity 0.15s ease, visibility 0.15s ease, transform 0.15s ease; transition-delay: 0.08s; pointer-events: none; z-index: 10000; }
                        [data-tooltip]:hover::after { opacity: 1; visibility: visible; transform: translate(-50%, 6px); }
                        .navbar-chat-sidebar-top-actions [data-tooltip]::after { left: auto; right: 0; transform: translate(0, 8px); }
                        .navbar-chat-sidebar-top-actions [data-tooltip]:hover::after { transform: translate(0, 6px); }
                        .navbar-messenger-icon-btn { background: none; border: none; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--primary-color, #6366f1); transition: background 0.2s, color 0.2s; margin-right: 4px; }
                        .navbar-messenger-icon-btn:hover { background: rgba(99, 102, 241, 0.1); color: var(--primary-color, #6366f1); }
                        .navbar-chat-sidebar-overlay { position: fixed; top: var(--navbar-height, 72px); left: 0; right: 0; bottom: 0; background: transparent; z-index: 9998; opacity: 0; visibility: hidden; transition: opacity 0.25s, visibility 0.25s; pointer-events: none; }
                        .navbar-chat-sidebar-overlay.is-open { opacity: 1; visibility: visible; }
                        .navbar-chat-sidebar { position: fixed; top: var(--navbar-height, 72px); right: 0; width: 360px; max-width: 100vw; height: calc(100vh - var(--navbar-height, 72px)); background: var(--card-bg, #fff); box-shadow: -4px 0 24px rgba(0,0,0,0.12); z-index: 9999; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease; border-radius: 12px 0 0 12px; overflow: hidden; visibility: hidden; }
                        .navbar-chat-sidebar.is-open { transform: translateX(0); visibility: visible; }
                        .navbar-chat-sidebar-top { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid var(--border-color, #e5e7eb); flex-shrink: 0; }
                        .navbar-chat-sidebar-top h2 { margin: 0; font-size: 1.25rem; font-weight: 700; color: var(--text-color, #1f2937); }
                        .navbar-chat-sidebar-top-actions { display: flex; align-items: center; gap: 4px; }
                        .navbar-chat-sidebar-head-btn { width: 36px; height: 36px; border: none; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-light, #6b7280); background: transparent; cursor: pointer; text-decoration: none; transition: background 0.2s, color 0.2s; font-size: 1rem; }
                        .navbar-chat-sidebar-head-btn:hover { background: var(--bg-secondary, #f3f4f6); color: var(--primary-color, #6366f1); }
                        .navbar-chat-sidebar-close { width: 36px; height: 36px; border: none; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-light, #6b7280); background: transparent; cursor: pointer; transition: background 0.2s; }
                        .navbar-chat-sidebar-close:hover { background: var(--bg-secondary, #f3f4f6); color: var(--text-color, #1f2937); }
                        .navbar-chat-sidebar-content { flex: 1; overflow-y: auto; min-height: 0; display: flex; flex-direction: column; }
                        .navbar-chat-sidebar-new-panel { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
                        .navbar-chat-sidebar-new-panel-back { padding: 8px 16px; border-bottom: 1px solid var(--border-color, #e5e7eb); }
                        .navbar-chat-sidebar-back-btn { background: none; border: none; cursor: pointer; color: var(--primary-color, #6366f1); font-size: 0.9rem; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; padding: 6px 0; }
                        .navbar-chat-sidebar-back-btn:hover { text-decoration: underline; }
                        .navbar-chat-sidebar-new-panel-search { padding: 12px 16px; position: relative; }
                        .navbar-chat-sidebar-new-panel-search i { position: absolute; left: 28px; top: 50%; transform: translateY(-50%); color: var(--text-light, #6b7280); font-size: 0.9rem; }
                        .navbar-chat-sidebar-new-panel-search input { width: 100%; padding: 10px 14px 10px 36px; border: none; border-radius: 20px; font-size: 0.9rem; background: var(--bg-secondary, #f3f4f6); outline: none; transition: all 0.2s ease; }
                        .navbar-chat-sidebar-new-panel-search input:focus { background: var(--card-bg, #fff); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
                        .navbar-chat-sidebar-new-panel-results { flex: 1; overflow-y: auto; padding: 8px; }
                        .navbar-chat-sidebar-user-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
                        .navbar-chat-sidebar-user-item:hover { background: var(--bg-secondary, #f3f4f6); }
                        .navbar-chat-sidebar-user-item-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color, #6366f1); color: #fff; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
                        .navbar-chat-sidebar-user-item-name { font-weight: 500; color: var(--text-color, #1f2937); }
                        .navbar-chat-sidebar-reduced { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
                        .navbar-chat-sidebar-reduced-header { padding: 8px 16px; border-bottom: 1px solid var(--border-color, #e5e7eb); }
                        .navbar-chat-sidebar-iframe { flex: 1; width: 100%; border: none; min-height: 300px; }
                        .navbar-chat-sidebar-loading { padding: 24px; text-align: center; color: var(--text-light, #6b7280); }
                        .navbar-chat-sidebar-inner { padding: 0; }
                        .navbar-chat-sidebar-search-wrap { padding: 12px 16px; border-bottom: 1px solid var(--border-color, #e5e7eb); position: relative; }
                        .navbar-chat-sidebar-search-wrap i { position: absolute; left: 28px; top: 50%; transform: translateY(-50%); color: var(--text-light, #6b7280); font-size: 0.9rem; pointer-events: none; }
                        .navbar-chat-sidebar-list-search-input { width: 100%; padding: 10px 14px 10px 36px; border: none; border-radius: 20px; font-size: 0.9rem; background: var(--bg-secondary, #f3f4f6); color: var(--text-color, #1f2937); outline: none; transition: all 0.2s ease; }
                        .navbar-chat-sidebar-list-search-input::placeholder { color: var(--text-light, #9ca3af); }
                        .navbar-chat-sidebar-list-search-input:focus { background: var(--card-bg, #fff); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
                        .navbar-chat-sidebar-actions { padding: 12px 16px; display: flex; flex-direction: column; gap: 8px; border-bottom: 1px solid var(--border-color, #e5e7eb); }
                        .navbar-chat-sidebar-btn { display: block; text-align: center; padding: 10px 14px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; text-decoration: none; transition: background 0.2s, color 0.2s; }
                        .navbar-chat-sidebar-btn.full { background: var(--primary-color, #6366f1); color: #fff; }
                        .navbar-chat-sidebar-btn.full:hover { opacity: 0.9; }
                        .navbar-chat-sidebar-btn.new { background: var(--bg-secondary, #f3f4f6); color: var(--text-color, #1f2937); border: 1px solid var(--border-color, #e5e7eb); }
                        .navbar-chat-sidebar-btn.new:hover { background: var(--border-color, #e5e7eb); }
                        .navbar-chat-sidebar-threads { padding: 0; }
                        .navbar-chat-sidebar .thread-item { padding: 0; border-bottom: 1px solid var(--border-color, #e5e7eb); }
                        .navbar-chat-sidebar .thread-item-link { padding: 12px 16px; text-decoration: none; color: inherit; display: flex; align-items: center; gap: 12px; }
                        .navbar-chat-sidebar .thread-avatar { width: 44px; height: 44px; border-radius: 50%; background: var(--primary-color, #6366f1); color: #fff; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
                        .navbar-chat-sidebar .thread-content { flex: 1; min-width: 0; }
                        .navbar-chat-sidebar .thread-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
                        .navbar-chat-sidebar .thread-user { font-weight: 600; color: var(--text-color, #1f2937); font-size: 0.95rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
                        .navbar-chat-sidebar .thread-time { font-size: 0.75rem; color: var(--text-light, #6b7280); }
                        .navbar-chat-sidebar .thread-preview { font-size: 0.8rem; color: var(--text-light, #6b7280); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
                        .navbar-chat-sidebar .thread-kebab-wrap { display: none; }
                        /* Ligne unique : tabs + menu 3 points horizontaux */
                        .navbar-chat-sidebar-tabs-row { display: flex; align-items: center; gap: 8px; padding: 0 16px 12px; border-bottom: 1px solid var(--border-color, #e5e7eb); flex-shrink: 0; }
                        .navbar-chat-sidebar-tabs { display: flex; flex: 1; gap: 4px; min-width: 0; }
                        .navbar-chat-sidebar-tab { flex: 1; padding: 8px 10px; border: none; border-radius: 8px; font-size: 0.8rem; font-weight: 500; cursor: pointer; background: transparent; color: var(--text-light, #6b7280); transition: background 0.2s, color 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
                        .navbar-chat-sidebar-tab i { font-size: 0.9rem; opacity: 0.9; }
                        .navbar-chat-sidebar-tab:hover { background: var(--bg-secondary, #f3f4f6); color: var(--text-color, #1f2937); }
                        .navbar-chat-sidebar-tab.active { background: var(--primary-color, #6366f1); color: #fff; }
                        .navbar-chat-sidebar-tab.active i { opacity: 1; }
                        /* Menu 3 points horizontal */
                        .navbar-chat-sidebar-menu-wrap { position: relative; flex-shrink: 0; }
                        .navbar-chat-sidebar-menu-btn { width: 36px; height: 36px; border: none; border-radius: 8px; background: transparent; color: var(--text-light, #6b7280); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: background 0.2s; }
                        .navbar-chat-sidebar-menu-btn:hover { background: var(--bg-secondary, #f3f4f6); color: var(--text-color, #1f2937); }
                        .navbar-chat-sidebar-dropdown { position: absolute; right: 0; top: 100%; margin-top: 4px; background: var(--card-bg, #fff); border: 1px solid var(--border-color, #e5e7eb); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); min-width: 220px; z-index: 10; display: none; padding: 6px 0; }
                        .navbar-chat-sidebar-dropdown.is-open { display: block; }
                        .navbar-chat-sidebar-dropdown-item { display: flex; align-items: center; gap: 12px; padding: 10px 16px; font-size: 0.9rem; color: var(--text-color, #1f2937); text-decoration: none; transition: background 0.2s; }
                        .navbar-chat-sidebar-dropdown-item i { width: 20px; text-align: center; font-size: 1rem; color: var(--primary-color, #6366f1); }
                        .navbar-chat-sidebar-dropdown-item:hover { background: var(--bg-secondary, #f3f4f6); }
                        .navbar-chat-sidebar-dropdown-item:hover i { color: var(--primary-color, #6366f1); }
                        .navbar-chat-sidebar-thread-wrap { border-bottom: 1px solid var(--border-color, #e5e7eb); }
                        /* Footer "Tout voir dans Messenger" */
                        .navbar-chat-sidebar-footer { padding: 12px 16px; border-top: 1px solid var(--border-color, #e5e7eb); margin-top: auto; flex-shrink: 0; background: var(--card-bg, #fff); text-align: center; }
                        .navbar-chat-sidebar-see-all { display: inline-flex; align-items: center; gap: 6px; color: var(--primary-color, #6366f1); font-size: 0.9rem; text-decoration: none; transition: text-decoration 0.2s; }
                        .navbar-chat-sidebar-see-all:hover { text-decoration: underline; }
                        .navbar-chat-sidebar-see-all i { font-size: 0.8rem; }
                        /* Fenêtre flottante type Messenger - Positionnée en bas à droite */
                        header { overflow: visible !important; }
                        .messenger-float-root { position: fixed !important; bottom: 8px !important; right: 20px !important; z-index: 10000 !important; pointer-events: none; width: auto !important; height: auto !important; top: auto !important; left: auto !important; }
                        .messenger-float-root.is-open { pointer-events: auto; }
                        .messenger-float-root.is-open .messenger-float-widget { opacity: 1 !important; transform: translateY(0) scale(1) !important; visibility: visible !important; display: flex !important; }
                        .messenger-float-widget { width: 360px; max-width: calc(100vw - 40px); height: 500px; max-height: calc(100vh - 24px); background: var(--card-bg, #fff); border-radius: 12px 12px 0 0; box-shadow: 0 -4px 24px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.08); display: flex; flex-direction: column; overflow: hidden; opacity: 0; transform: translateY(0) scale(0.95); visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s; position: relative; }
                        .messenger-float-widget.is-minimized { width: 56px; height: 56px; border-radius: 50%; min-height: 56px; height: 56px !important; box-shadow: 0 4px 14px rgba(99, 102, 241, 0.35), 0 0 0 1px rgba(255,255,255,0.2) inset; overflow: visible; }
                        .messenger-float-widget.is-minimized .messenger-float-header { border-radius: 50%; padding: 0; min-height: 0; background: linear-gradient(145deg, var(--primary-color, #6366f1) 0%, var(--primary-dark, #4f46e5) 100%); }
                        .messenger-float-widget.is-minimized .messenger-float-header-info { flex: 1; justify-content: center; padding: 0; }
                        .messenger-float-widget.is-minimized .messenger-float-title { display: none; }
                        .messenger-float-widget.is-minimized .messenger-float-actions { position: absolute; top: 0; right: 0; gap: 0; }
                        .messenger-float-widget.is-minimized .messenger-float-minimize { display: none; }
                        .messenger-float-widget.is-minimized .messenger-float-summary { display: none; }
                        .messenger-float-widget.is-minimized .messenger-float-close { width: 22px; height: 22px; min-width: 22px; min-height: 22px; font-size: 0.65rem; background: rgba(0,0,0,0.25); color: #fff; border: none; border-radius: 50%; top: -2px; right: -2px; position: absolute; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; }
                        .messenger-float-widget.is-minimized .messenger-float-close:hover { background: rgba(0,0,0,0.45); }
                        .messenger-float-widget.is-minimized .messenger-float-avatar { width: 56px; height: 56px; font-size: 1.15rem; font-weight: 700; background: transparent; color: #fff; text-rendering: optimizeLegibility; -webkit-font-smoothing: antialiased; letter-spacing: -0.02em; }
                        .messenger-float-widget.is-minimized .messenger-float-body { display: none; }
                        .messenger-float-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: linear-gradient(135deg, var(--primary-color, #6366f1) 0%, #4f46e5 100%); color: #fff; flex-shrink: 0; cursor: pointer; min-height: 52px; }
                        .messenger-float-header-info { display: flex; align-items: center; gap: 10px; min-width: 0; flex: 1; }
                        .messenger-float-avatar { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.25); font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
                        .messenger-float-title { font-weight: 600; font-size: 0.95rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
                        .messenger-float-actions { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
                        .messenger-float-btn { width: 32px; height: 32px; border: none; border-radius: 50%; background: rgba(255,255,255,0.2); color: #fff; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 0.85rem; transition: background 0.2s, transform 0.2s; }
                        .messenger-float-btn:hover { background: rgba(255,255,255,0.35); transform: scale(1.1); }
                        .messenger-float-body { flex: 1; min-height: 0; display: flex; flex-direction: column; background: var(--card-bg, #fff); overflow: hidden; }
                        .messenger-float-loading { padding: 24px; text-align: center; color: var(--text-light, #6b7280); font-size: 0.9rem; }
                        .messenger-float-conversation { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
                        .messenger-float-messages { flex: 1; min-height: 0; overflow-y: auto; padding: 8px 12px 4px; scroll-behavior: smooth; }
                        .messenger-float-messages-inner { display: flex; flex-direction: column; justify-content: flex-end; min-height: 100%; }
                        .messenger-float-messages .message-section { margin-bottom: 0; }
                        .messenger-float-messages .message-bubble-wrap { max-width: 100%; gap: 0; }
                        .messenger-float-messages .message-footer { margin-top: 0; margin-bottom: 2px; }
                        .messenger-float-messages .message-footer:has(.reaction-pill) { margin-bottom: 10px; }
                        .messenger-float-messages .message-avatar { width: 28px; height: 28px; font-size: 0.75rem; }
                        .messenger-float-messages .message-content { font-size: 0.9rem; padding: 8px 12px; }
                        .messenger-float-conversation .message-input-area { border-top: 1px solid var(--border-color, #e5e7eb); padding: 6px 12px 8px; flex-shrink: 0; background: var(--card-bg, #fff); }
                        .messenger-float-conversation .input-container { padding: 6px 10px; }
                        .messenger-float-conversation .message-input { font-size: 0.9rem; padding: 8px 12px; }
                        .messenger-float-conversation .send-button { width: 32px; height: 32px; font-size: 0.85rem; }
                        /* Assurer que les styles de messages s'appliquent dans la fenêtre flottante */
                        .messenger-float-body .message-section.you { justify-content: flex-end; }
                        .messenger-float-body .message-section.other { justify-content: flex-start; }
                        /* Variables Messenger pour le contenu du widget (hors page /messenger) */
                        .messenger-float-body { --conv-primary: var(--primary-color, #6366f1); --conv-primary-dark: var(--primary-dark, #4f46e5); --secondary-color: var(--primary-color, #6366f1); }
                        /* Modal confirmation suppression (mode réduit) */
                        .float-delete-confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 10001; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; }
                        .float-delete-confirm-overlay.is-open { opacity: 1; visibility: visible; }
                        .float-delete-confirm-modal { background: var(--card-bg, #fff); border-radius: 12px; padding: 24px; box-shadow: 0 12px 40px rgba(0,0,0,0.2); min-width: 320px; }
                        .float-delete-confirm-text { margin: 0 0 20px; font-size: 1rem; color: var(--text-color, #1f2937); }
                        .float-delete-confirm-actions { display: flex; gap: 12px; justify-content: flex-end; }
                        .float-delete-confirm-btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 0.95rem; }
                        .float-delete-cancel { background: var(--bg-secondary, #f3f4f6); color: var(--text-color, #1f2937); }
                        .float-delete-submit { background: #dc3545; color: #fff; }
                        .float-delete-submit:hover { background: #c82333; }
                        /* Modal résumé (float) - styles pour usage hors page messenger */
                        .float-summary-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(6px); z-index: 10001; align-items: center; justify-content: center; padding: 24px; }
                        .float-summary-modal-overlay.is-open { display: flex; }
                        .float-summary-modal-overlay .summary-conv-modal { width: 100%; max-width: 520px; max-height: 85vh; display: flex; flex-direction: column; background: var(--card-bg, #fff); border-radius: 20px; box-shadow: 0 24px 48px rgba(0,0,0,0.18); border: 1px solid var(--border-color, #e5e7eb); overflow: hidden; }
                        .float-summary-modal-overlay .summary-conv-modal-header { position: relative; padding: 28px 24px 20px; text-align: center; background: linear-gradient(180deg, rgba(13, 110, 253, 0.08) 0%, transparent 100%); border-bottom: 1px solid var(--border-color, #e5e7eb); }
                        .float-summary-modal-overlay .summary-conv-modal-header-icon { width: 56px; height: 56px; margin: 0 auto 14px; border-radius: 50%; background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; }
                        .float-summary-modal-overlay .summary-conv-modal-title { margin: 0 0 6px; font-size: 20px; font-weight: 700; color: var(--text-color, #1f2937); }
                        .float-summary-modal-overlay .summary-conv-modal-subtitle { margin: 0; font-size: 14px; color: var(--text-light, #6b7280); }
                        .float-summary-modal-overlay .summary-conv-modal-close { position: absolute; top: 16px; right: 16px; width: 38px; height: 38px; border: none; background: rgba(0,0,0,0.06); cursor: pointer; border-radius: 50%; color: var(--text-light); display: flex; align-items: center; justify-content: center; font-size: 16px; }
                        .float-summary-modal-overlay .summary-conv-modal-body { padding: 24px; overflow-y: auto; flex: 1; min-height: 0; }
                        .float-summary-modal-overlay .summary-conv-loading { text-align: center; padding: 32px 16px; }
                        .float-summary-modal-overlay .summary-conv-spinner { width: 44px; height: 44px; margin: 0 auto 16px; border: 3px solid var(--border-color, #e5e7eb); border-top-color: var(--primary-color, #6366f1); border-radius: 50%; animation: floatSummarySpin 0.9s linear infinite; }
                        @keyframes floatSummarySpin { to { transform: rotate(360deg); } }
                        .float-summary-modal-overlay .summary-conv-loading-text { margin: 0; font-size: 15px; color: var(--text-light, #6b7280); }
                        .float-summary-modal-overlay .summary-conv-loading-hint { margin: 8px 0 0; font-size: 13px; color: var(--text-light, #6b7280); }
                        .float-summary-modal-overlay .summary-conv-text { padding: 18px 20px; background: var(--bg-secondary, #f3f4f6); border-radius: 14px; font-size: 15px; line-height: 1.6; color: var(--text-color, #1f2937); white-space: pre-wrap; }
                        .float-summary-modal-overlay .summary-conv-saved-hint { margin: 12px 0 0; font-size: 13px; color: var(--text-light, #6b7280); }
                        .float-summary-modal-overlay .summary-conv-btn-regenerate { margin-top: 14px; background: var(--bg-secondary, #f3f4f6); color: var(--text-color, #1f2937); border: 1px solid var(--border-color, #e5e7eb); }
                        .float-summary-modal-overlay .summary-conv-btn-regenerate i { margin-right: 6px; }
                        .float-summary-modal-overlay .summary-conv-saved-hint i { color: #0d9488; }
                        .float-summary-modal-overlay .summary-conv-error { text-align: center; padding: 24px 16px; margin-bottom: 16px; background: rgba(220, 53, 69, 0.06); border-radius: 14px; }
                        .float-summary-modal-overlay .summary-conv-error-icon { font-size: 32px; color: #dc3545; margin-bottom: 12px; }
                        .float-summary-modal-overlay .summary-conv-error-text { margin: 0 0 8px; font-size: 14px; color: var(--text-color, #1f2937); }
                        .float-summary-modal-overlay .summary-conv-error-debug { margin: 0 0 16px; font-size: 12px; color: var(--text-light); word-break: break-word; padding: 8px 10px; background: rgba(0,0,0,0.06); border-radius: 8px; }
                        .float-summary-modal-overlay .summary-conv-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 8px; }
                        .float-summary-modal-overlay .summary-conv-btn { padding: 12px 22px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; border: none; background: var(--bg-secondary, #f3f4f6); color: var(--text-color, #1f2937); }
                        .float-summary-modal-overlay .summary-conv-btn-close { background: var(--primary-color, #6366f1); color: #fff; }
                        .float-summary-modal-overlay .summary-conv-btn-close:hover { background: var(--primary-color, #6366f1); color: #fff; filter: brightness(1.1); }
                        .float-summary-modal-overlay .summary-conv-btn-retry { background: var(--primary-color, #6366f1); color: #fff; }
                        #messengerFloatTransferModalContainer .transfer-modal-overlay { z-index: 10001; }
                        #messengerFloatTransferModalContainer .transfer-modal-body { display: flex; flex-direction: column; min-height: 0; padding: 20px 24px; }
                        #messengerFloatTransferModalContainer .transfer-list { flex: 1; min-height: 0; overflow-y: auto; max-height: 280px; }
                        #messengerFloatTransferModalContainer .transfer-contact { display: flex; align-items: center; gap: 14px; padding: 12px 14px; border-radius: 10px; cursor: pointer; transition: background 0.2s; }
                        #messengerFloatTransferModalContainer .transfer-contact-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color, #6366f1), var(--primary-dark, #4f46e5)); color: #fff; font-weight: 700; font-size: 16px; display: flex !important; align-items: center; justify-content: center; flex-shrink: 0; }
                        #messengerFloatTransferModalContainer .transfer-contact-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 2px; }
                        #messengerFloatTransferModalContainer .transfer-contact-name { font-size: 15px; font-weight: 600; color: var(--text-color, #1f2937); }
                        #messengerFloatTransferModalContainer .transfer-contact-username { font-size: 13px; color: var(--text-light, #6b7280); }
                        #messengerFloatTransferModalContainer .transfer-submit { display: block !important; width: 100%; padding: 14px 20px; margin-top: 16px; flex-shrink: 0; border: none; border-radius: 10px; background: var(--primary-color, #6366f1); color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
                        #messengerFloatTransferModalContainer .transfer-submit:hover { background: var(--primary-dark, #4f46e5); transform: translateY(-1px); }
                        #messengerFloatTransferModalContainer .transfer-archived-badge { font-size: 12px; font-weight: 500; color: var(--text-light, #6b7280); margin-left: 4px; }
                        .float-edit-message-wrap { margin: 0 12px 12px; padding: 8px 16px 12px; background: var(--bg-secondary, #f3f4f6); border-left: 3px solid var(--primary-color, #6366f1); border-radius: 8px; }
                        .float-edit-message-label { margin: 0 0 8px; font-size: 13px; color: var(--text-light, #6b7280); display: flex; align-items: center; gap: 6px; }
                        .float-edit-message-label i { color: var(--primary-color, #6366f1); }
                        .float-edit-message-textarea { width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 10px; font-size: 13px; line-height: 1.4; background: var(--card-bg, #fff); color: var(--text-color); outline: none; resize: vertical; min-height: 70px; box-sizing: border-box; }
                        .float-edit-message-textarea:focus { border-color: var(--primary-color, #6366f1); }
                        .float-edit-message-actions { display: flex; gap: 8px; flex-wrap: wrap; }
                        .float-edit-btn { padding: 8px 14px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; text-decoration: none; }
                        .float-edit-submit { background: var(--primary-color, #6366f1); color: #fff; }
                        .float-edit-submit:hover { background: var(--primary-dark, #4f46e5); color: #fff; }
                        .float-edit-cancel { background: var(--card-bg, #fff); color: var(--text-color, #374151); border: 1px solid var(--border-color, #e5e7eb); }
                        .float-edit-cancel:hover { background: var(--bg-secondary, #f3f4f6); }
                        /* Portail pour kebab / emoji en mode réduit (affichage complet, style Messenger) */
                        #messengerFloatDropdownPortal { position: fixed; left: 0; top: 0; z-index: 10002; pointer-events: none; }
                        #messengerFloatDropdownPortal .messenger-float-portal-wrap { pointer-events: auto; }
                        #messengerFloatDropdownPortal .kebab-dropdown,
                        #messengerFloatDropdownPortal .emoji-picker { position: relative !important; top: auto !important; bottom: auto !important; right: auto !important; left: auto !important; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
                        #messengerFloatDropdownPortal .emoji-picker { display: flex !important; flex-wrap: wrap; }
                    </style>
                    <script>
                        (function() {
                            // Déplacer la fenêtre flottante et les modals dans body pour position:fixed correct
                            var floatRootEl = document.getElementById('messengerFloatRoot');
                            var floatModalsWrap = document.getElementById('messengerFloatModalsWrap');
                            if (document.body) {
                                if (floatRootEl) document.body.appendChild(floatRootEl);
                                if (floatModalsWrap) document.body.appendChild(floatModalsWrap);
                            }
                            var btn = document.getElementById('navbarMessengerIconBtn');
                            var overlay = document.getElementById('navbarChatSidebarOverlay');
                            var sidebar = document.getElementById('navbarChatSidebar');
                            var closeBtn = document.getElementById('navbarChatSidebarClose');
                            var content = document.getElementById('navbarChatSidebarContent');
                            var loading = document.getElementById('navbarChatSidebarLoading');
                            var sidebarUrl = '{{ path('app_messenger_sidebar_content') }}';
                            var searchUsersUrl = '{{ path('app_messenger_search_users') }}';
                            var loaded = false;
                            var newPanel = document.getElementById('navbarChatSidebarNewPanel');
                            var reducedEl = document.getElementById('navbarChatSidebarReduced');
                            var iframeEl = document.getElementById('navbarChatSidebarIframe');
                            var userSearchInput = document.getElementById('navbarChatSidebarUserSearch');
                            var userResultsEl = document.getElementById('navbarChatSidebarUserResults');
                            var searchTimeout = null;

                            function closeSidebar() {
                                if (overlay) { overlay.classList.remove('is-open'); overlay.setAttribute('aria-hidden', 'true'); }
                                if (sidebar) { sidebar.classList.remove('is-open'); sidebar.setAttribute('aria-hidden', 'true'); }
                            }
                            closeSidebar();

                            function showView(view) {
                                if (content) content.style.display = view === 'list' ? 'flex' : 'none';
                                if (newPanel) newPanel.style.display = view === 'new' ? 'flex' : 'none';
                                if (reducedEl) reducedEl.style.display = view === 'reduced' ? 'flex' : 'none';
                            }

                            function openSidebar() {
                                overlay.classList.add('is-open');
                                sidebar.classList.add('is-open');
                                overlay.setAttribute('aria-hidden', 'false');
                                sidebar.setAttribute('aria-hidden', 'false');
                                showView('list');
                                if (!loaded) {
                                    fetch(sidebarUrl, { credentials: 'same-origin' }).then(function(r) {
                                        if (r.ok) return r.text();
                                        throw new Error('Unauthorized');
                                    }).then(function(html) {
                                        content.innerHTML = html;
                                        loaded = true;
                                    }).catch(function() {
                                        content.innerHTML = '<p style="padding:16px;color:#b91c1c;">Connexion requise.</p>';
                                    });
                                }
                            }
                            if (document.getElementById('navbarChatSidebarNewMsgBtn')) {
                                document.getElementById('navbarChatSidebarNewMsgBtn').addEventListener('click', function() {
                                    showView('new');
                                    if (userResultsEl) userResultsEl.innerHTML = '';
                                    if (userSearchInput) userSearchInput.value = '';
                                });
                            }
                            if (document.getElementById('navbarChatSidebarBackFromNew')) {
                                document.getElementById('navbarChatSidebarBackFromNew').addEventListener('click', function() {
                                    showView('list');
                                });
                            }
                            if (document.getElementById('navbarChatSidebarBackFromReduced')) {
                                document.getElementById('navbarChatSidebarBackFromReduced').addEventListener('click', function() {
                                    if (iframeEl) iframeEl.src = 'about:blank';
                                    showView('list');
                                });
                            }

                            if (userSearchInput && userResultsEl) {
                                userSearchInput.addEventListener('input', function() {
                                    var q = userSearchInput.value.trim();
                                    if (searchTimeout) clearTimeout(searchTimeout);
                                    if (q.length < 2) {
                                        userResultsEl.innerHTML = q.length === 0 ? '' : '<p class="navbar-chat-sidebar-search-hint" style="padding:12px;color:var(--text-light,#6b7280);font-size:0.85rem;">Tapez au moins 2 caractères</p>';
                                        return;
                                    }
                                    searchTimeout = setTimeout(function() {
                                        fetch(searchUsersUrl + '?q=' + encodeURIComponent(q), { credentials: 'same-origin' })
                                            .then(function(r) { return r.json(); })
                                            .then(function(data) {
                                                var results = data.results || [];
                                                if (results.length === 0) {
                                                    userResultsEl.innerHTML = '<p class="navbar-chat-sidebar-search-hint" style="padding:12px;color:var(--text-light,#6b7280);font-size:0.85rem;">Aucun utilisateur trouvé</p>';
                                                    return;
                                                }
                                                userResultsEl.innerHTML = results.map(function(u) {
                                                    var initials = (u.fullName || '').split(' ').map(function(s) { return s.charAt(0); }).join('').toUpperCase().slice(0, 2) || '?';
                                                    var url = u.showUrl || u.newConversationUrl || '#';
                                                    return '<div class="navbar-chat-sidebar-user-item" data-url="' + String(url).replace(/"/g, '&quot;') + '"><div class="navbar-chat-sidebar-user-item-avatar">' + initials + '</div><div class="navbar-chat-sidebar-user-item-name">' + (u.fullName || u.email || '') + '</div></div>';
                                                }).join('');
                                            })
                                            .catch(function() {
                                                userResultsEl.innerHTML = '<p class="navbar-chat-sidebar-search-hint" style="padding:12px;color:#b91c1c;font-size:0.85rem;">Erreur de recherche</p>';
                                            });
                                    }, 300);
                                });
                            }

                            if (userResultsEl) {
                                userResultsEl.addEventListener('click', function(e) {
                                    var item = e.target.closest('.navbar-chat-sidebar-user-item');
                                    if (!item) return;
                                    var url = item.getAttribute('data-url');
                                    if (url && url !== '#') {
                                        if (iframeEl) iframeEl.src = url;
                                        showView('reduced');
                                    }
                                });
                            }

                            /* Clic sur une conversation dans le panel : fermer le panel et ouvrir en fenêtre flottante (type Messenger) */
                            var floatRoot = document.getElementById('messengerFloatRoot');
                            var floatWidget = document.getElementById('messengerFloatWidget');
                            var floatBody = document.getElementById('messengerFloatBody');
                            var floatLoading = document.getElementById('messengerFloatLoading');
                            var floatTitleEl = document.getElementById('messengerFloatTitle');
                            var floatAvatarEl = document.getElementById('messengerFloatAvatar');
                            var floatMinimizeBtn = document.getElementById('messengerFloatMinimize');
                            var floatCloseBtn = document.getElementById('messengerFloatClose');

                            function extractConvId(url) {
                                var match = url.match(/\/(\d+)(?:\?|$)/);
                                return match ? match[1] : null;
                            }

                            function updateFloatBodyContent(html, opts) {
                                if (!floatBody || !html) return;
                                opts = opts || {};
                                var tmp = document.createElement('div');
                                tmp.innerHTML = html;
                                var newConv = tmp.querySelector('.messenger-float-conversation');
                                if (!newConv) {
                                    floatBody.innerHTML = html;
                                    return;
                                }
                                var convId = newConv.getAttribute('data-conv-id');
                                var existingConv = floatBody.querySelector('.messenger-float-conversation');
                                if (existingConv && existingConv.getAttribute('data-conv-id') === convId) {
                                    var existingInner = existingConv.querySelector('.messenger-float-messages-inner');
                                    var newInner = newConv.querySelector('.messenger-float-messages-inner');
                                    var existingMessages = existingConv.querySelector('.messenger-float-messages');
                                    if (existingInner && newInner) existingInner.innerHTML = newInner.innerHTML;
                                    var existingInput = existingConv.querySelector('.message-input-area');
                                    var newInput = newConv.querySelector('.message-input-area');
                                    if (existingInput && newInput) existingInput.replaceWith(newInput);
                                    if (existingMessages) {
                                        if (opts.preserveScroll && opts.scrollTop != null && opts.scrollHeight > 0) {
                                            existingMessages.scrollTop = (existingMessages.scrollHeight * opts.scrollTop) / opts.scrollHeight;
                                        } else {
                                            existingMessages.scrollTop = existingMessages.scrollHeight;
                                        }
                                    }
                                } else {
                                    floatBody.innerHTML = html;
                                    var messagesEl = floatBody.querySelector('.messenger-float-messages');
                                    if (messagesEl) messagesEl.scrollTop = messagesEl.scrollHeight;
                                }
                            }

                            function openFloatingChat(url, title, initials) {
                                if (!floatRoot || !floatWidget || !floatBody) return;
                                var convId = extractConvId(url);
                                if (!convId) return;
                                if (floatTitleEl) floatTitleEl.textContent = title || 'Conversation';
                                if (floatAvatarEl) floatAvatarEl.textContent = (initials || '?').slice(0, 2).toUpperCase();
                                floatWidget.classList.remove('is-minimized');
                                floatRoot.classList.add('is-open');
                                floatRoot.setAttribute('aria-hidden', 'false');
                                
                                // Afficher le loading
                                if (floatLoading) floatLoading.style.display = 'block';
                                floatBody.innerHTML = '';
                                
                                // Charger le contenu de la conversation via AJAX
                                var floatContentUrl = '{{ path('app_messenger_float_content', { id: 0 }) }}'.replace('/0/float-content', '/' + convId + '/float-content');
                                fetch(floatContentUrl, { credentials: 'same-origin' })
                                    .then(function(r) {
                                        if (!r.ok) throw new Error('Erreur de chargement');
                                        return r.text();
                                    })
                                    .then(function(html) {
                                        if (floatLoading) floatLoading.style.display = 'none';
                                        updateFloatBodyContent(html);
                                    })
                                    .catch(function(err) {
                                        if (floatLoading) floatLoading.style.display = 'none';
                                        floatBody.innerHTML = '<div style="padding:24px;text-align:center;color:#b91c1c;">Erreur de chargement de la conversation.</div>';
                                        console.error('Erreur:', err);
                                    });
                            }

                            function closeFloatingChat() {
                                if (floatRoot) {
                                    floatRoot.classList.remove('is-open');
                                    floatRoot.setAttribute('aria-hidden', 'true');
                                }
                                if (floatBody) floatBody.innerHTML = '';
                            }

                            if (sidebar) {
                                sidebar.addEventListener('click', function(e) {
                                    var link = e.target.closest('a.thread-item-link');
                                    if (!link || !link.href) return;
                                    var wrap = link.closest('.navbar-chat-sidebar-thread-wrap');
                                    if (!wrap || !sidebar.contains(wrap)) return;
                                    e.preventDefault();
                                    var url = link.getAttribute('href');
                                    var userEl = wrap.querySelector('.thread-user');
                                    var avatarEl = wrap.querySelector('.thread-avatar');
                                    var title = userEl ? userEl.textContent.trim() : 'Conversation';
                                    var initials = avatarEl ? avatarEl.textContent.trim().slice(0, 2) : '?';
                                    closeSidebar();
                                    showView('list');
                                    openFloatingChat(url, title, initials);
                                });
                            }

                            if (floatMinimizeBtn) {
                                floatMinimizeBtn.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    if (floatWidget) floatWidget.classList.add('is-minimized');
                                });
                            }
                            if (floatCloseBtn) {
                                floatCloseBtn.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    closeFloatingChat();
                                });
                            }
                            /* Icône Résumer (float) : ouvre le modal résumé et appelle l’API */
                            var floatSummaryBtn = document.getElementById('messengerFloatSummaryBtn');
                            var floatSummaryOverlay = document.getElementById('floatSummaryModalOverlay');
                            var floatSummaryLoading = document.getElementById('floatSummaryLoading');
                            var floatSummaryContent = document.getElementById('floatSummaryContent');
                            var floatSummaryText = document.getElementById('floatSummaryText');
                            var floatSummaryError = document.getElementById('floatSummaryError');
                            var floatSummaryErrorText = document.getElementById('floatSummaryErrorText');
                            var floatSummaryErrorDebug = document.getElementById('floatSummaryErrorDebug');
                            var floatSummaryClose = document.getElementById('floatSummaryModalClose');
                            var floatSummaryBtnClose = document.getElementById('floatSummaryBtnClose');
                            var floatSummaryRetry = document.getElementById('floatSummaryRetry');
                            var floatSummaryRegenerate = document.getElementById('floatSummaryRegenerate');
                            var summaryUrlTemplate = (floatRoot && floatRoot.getAttribute('data-summary-url-template')) || '';
                            function floatSummaryShowState(loading, content, err) {
                                if (floatSummaryLoading) floatSummaryLoading.style.display = loading ? 'block' : 'none';
                                if (floatSummaryContent) floatSummaryContent.style.display = content ? 'block' : 'none';
                                if (floatSummaryError) floatSummaryError.style.display = err ? 'block' : 'none';
                            }
                            function getFloatSummaryUrl() {
                                var convEl = floatBody && floatBody.querySelector('.messenger-float-conversation');
                                var convId = convEl ? convEl.getAttribute('data-conv-id') : '';
                                if (!convId || !summaryUrlTemplate) return '';
                                return summaryUrlTemplate.replace(/\/0\//, '/' + convId + '/').replace(/\/0$/, '/' + convId);
                            }
                            function floatSummaryFetch() {
                                var url = getFloatSummaryUrl();
                                if (!url) return;
                                floatSummaryShowState(true, false, false);
                                if (floatSummaryText) floatSummaryText.textContent = '';
                                if (floatSummaryErrorDebug) { floatSummaryErrorDebug.textContent = ''; floatSummaryErrorDebug.style.display = 'none'; }
                                fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } })
                                    .then(function(r) { return r.json(); })
                                    .then(function(data) {
                                        if (data.ok && data.summary !== undefined) {
                                            if (floatSummaryText) floatSummaryText.textContent = data.summary;
                                            floatSummaryShowState(false, true, false);
                                        } else {
                                            if (floatSummaryErrorText) floatSummaryErrorText.textContent = data.error || 'Impossible de générer le résumé.';
                                            if (floatSummaryErrorDebug && data.debug) {
                                                floatSummaryErrorDebug.textContent = 'Détail : ' + data.debug;
                                                floatSummaryErrorDebug.style.display = 'block';
                                            }
                                            floatSummaryShowState(false, false, true);
                                        }
                                    })
                                    .catch(function() {
                                        if (floatSummaryErrorText) floatSummaryErrorText.textContent = 'Erreur de connexion. Réessayez.';
                                        floatSummaryShowState(false, false, true);
                                    });
                            }
                            function openFloatSummaryModal() {
                                var url = getFloatSummaryUrl();
                                if (!url || !floatSummaryOverlay) return;
                                floatSummaryOverlay.classList.add('is-open');
                                floatSummaryOverlay.setAttribute('aria-hidden', 'false');
                                floatSummaryShowState(true, false, false);
                                if (floatSummaryText) floatSummaryText.textContent = '';
                                fetch(url, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } })
                                    .then(function(r) { return r.json(); })
                                    .then(function(data) {
                                        if (data.ok && data.cached && data.summary) {
                                            if (floatSummaryText) floatSummaryText.textContent = data.summary;
                                            floatSummaryShowState(false, true, false);
                                        } else {
                                            floatSummaryFetch();
                                        }
                                    })
                                    .catch(function() { floatSummaryFetch(); });
                            }
                            function closeFloatSummaryModal() {
                                if (floatSummaryOverlay) {
                                    floatSummaryOverlay.classList.remove('is-open');
                                    floatSummaryOverlay.setAttribute('aria-hidden', 'true');
                                }
                            }
                            if (floatSummaryBtn) floatSummaryBtn.addEventListener('click', function(e) { e.stopPropagation(); openFloatSummaryModal(); });
                            if (floatSummaryClose) floatSummaryClose.addEventListener('click', closeFloatSummaryModal);
                            if (floatSummaryBtnClose) floatSummaryBtnClose.addEventListener('click', closeFloatSummaryModal);
                            if (floatSummaryRetry) floatSummaryRetry.addEventListener('click', floatSummaryFetch);
                            if (floatSummaryRegenerate) floatSummaryRegenerate.addEventListener('click', floatSummaryFetch);
                            if (floatSummaryOverlay) {
                                floatSummaryOverlay.addEventListener('click', function(e) { if (e.target === floatSummaryOverlay) closeFloatSummaryModal(); });
                                var floatSummaryModalEl = document.getElementById('floatSummaryModal');
                                if (floatSummaryModalEl) floatSummaryModalEl.addEventListener('click', function(e) { e.stopPropagation(); });
                            }
                            if (floatWidget) {
                                floatWidget.addEventListener('click', function(e) {
                                    if (floatWidget.classList.contains('is-minimized') && (e.target.closest('.messenger-float-header') || e.target === floatWidget)) {
                                        e.preventDefault();
                                        floatWidget.classList.remove('is-minimized');
                                    }
                                });
                            }
                            
                            // Gérer la soumission des formulaires dans la fenêtre flottante (un seul handler pour tout intercepter)
                            if (floatBody) {
                                floatBody.addEventListener('submit', function(e) {
                                    var form = e.target.closest('form');
                                    if (!form || !floatBody.contains(form)) return;
                                    var action = (form.getAttribute('action') || '');
                                    if (form.classList.contains('send-message-form')) {
                                        e.preventDefault();
                                        var formData = new FormData(form);
                                        fetch(form.getAttribute('action'), { method: 'POST', body: formData, credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                                            .then(function(r) {
                                                if (r.redirected) {
                                                    var convEl = floatBody.querySelector('.messenger-float-conversation');
                                                    if (convEl) {
                                                        var convId = convEl.getAttribute('data-conv-id');
                                                        if (convId) {
                                                            var floatContentUrl = '{{ path('app_messenger_float_content', { id: 0 }) }}'.replace('/0/float-content', '/' + convId + '/float-content');
                                                            return fetch(floatContentUrl, { credentials: 'same-origin' }).then(function(r2) { return r2.text(); });
                                                        }
                                                    }
                                                    return Promise.resolve('');
                                                }
                                                return r.text();
                                            })
                                            .then(function(html) {
                                                if (html) {
                                                    updateFloatBodyContent(html);
                                                    var input = floatBody.querySelector('#messageInput');
                                                    if (input) input.value = '';
                                                }
                                            })
                                            .catch(function(err) { console.error('Erreur envoi:', err); });
                                        return;
                                    }
                                    e.preventDefault();
                                    if (action.indexOf('delete_message') !== -1 || (action.indexOf('/message/') !== -1 && action.indexOf('/delete') !== -1)) {
                                        pendingDeleteForm = form;
                                        if (floatDeleteOverlay) { floatDeleteOverlay.classList.add('is-open'); floatDeleteOverlay.setAttribute('aria-hidden', 'false'); }
                                        return;
                                    }
                                    if (action.indexOf('reaction') !== -1) {
                                        var fd = new FormData(form);
                                        fetch(form.getAttribute('action'), { method: 'POST', body: fd, credentials: 'same-origin' })
                                            .then(function() { reloadFloatConversation(true); })
                                            .catch(function() { reloadFloatConversation(true); });
                                        return;
                                    }
                                    if (form.classList.contains('float-edit-message-form')) {
                                        var fd = new FormData(form);
                                        fetch(form.getAttribute('action'), { method: 'POST', body: fd, credentials: 'same-origin' })
                                            .then(function() {
                                                var wrap = floatBody.querySelector('.float-edit-message-wrap');
                                                if (wrap) wrap.remove();
                                                reloadFloatConversation(true);
                                            })
                                            .catch(function() { reloadFloatConversation(true); });
                                    }
                                });
                            }

                            document.addEventListener('submit', function(e) {
                                var form = e.target.closest('form');
                                if (!form || !dropdownPortal || !dropdownPortal.contains(form)) return;
                                var action = (form.getAttribute('action') || '');
                                e.preventDefault();
                                if (action.indexOf('delete_message') !== -1 || (action.indexOf('/message/') !== -1 && action.indexOf('/delete') !== -1)) {
                                    pendingDeleteForm = form;
                                    if (floatDeleteOverlay) { floatDeleteOverlay.classList.add('is-open'); floatDeleteOverlay.setAttribute('aria-hidden', 'false'); }
                                    return;
                                }
                                if (action.indexOf('reaction') !== -1) {
                                    var fd = new FormData(form);
                                    fetch(form.getAttribute('action'), { method: 'POST', body: fd, credentials: 'same-origin' })
                                        .then(function() { closeFloatPickers(); reloadFloatConversation(true); })
                                        .catch(function() { closeFloatPickers(); reloadFloatConversation(true); });
                                }
                            });

                            document.addEventListener('click', function(ev) {
                                if (!dropdownPortal || !floatBody) return;
                                if (!dropdownPortal.contains(ev.target)) return;
                                var convEl = floatBody.querySelector('.messenger-float-conversation');
                                var convId = convEl ? convEl.getAttribute('data-conv-id') : '';
                                var copyBtn = ev.target.closest('.dropdown-copy');
                                if (copyBtn) {
                                    ev.preventDefault();
                                    var text = copyBtn.getAttribute('data-copy-text') || '';
                                    copyToClipboard(text, function() {
                                        var orig = copyBtn.innerHTML;
                                        copyBtn.innerHTML = '<i class="fas fa-check" style="margin-right:8px;width:16px;"></i>Copié !';
                                        setTimeout(function() { copyBtn.innerHTML = orig; }, 1500);
                                    });
                                    closeFloatPickers();
                                    return;
                                }
                                var transferBtn = ev.target.closest('.dropdown-transfer');
                                if (transferBtn && convId) {
                                    ev.preventDefault();
                                    var msgId = transferBtn.getAttribute('data-transfer-msg-id');
                                    if (!msgId) return;
                                    closeFloatPickers();
                                    fetch(transferModalContentUrl + '?exclude=' + encodeURIComponent(convId), { credentials: 'same-origin' })
                                        .then(function(r) { return r.text(); })
                                        .then(function(html) {
                                            if (!transferModalContainer) return;
                                            transferModalContainer.innerHTML = html;
                                            var overlay = transferModalContainer.querySelector('.transfer-modal-overlay');
                                            var msgInput = transferModalContainer.querySelector('#transferMessageId');
                                            var targetInput = transferModalContainer.querySelector('#transferTargetConvId');
                                            var form = transferModalContainer.querySelector('#transferForm');
                                            var closeBtn = transferModalContainer.querySelector('#transferModalClose');
                                            var searchInput = transferModalContainer.querySelector('#transferSearch');
                                            var list = transferModalContainer.querySelector('#transferList');
                                            if (msgInput) msgInput.value = msgId;
                                            if (targetInput) targetInput.value = '';
                                            if (searchInput) searchInput.value = '';
                                            if (list) {
                                                list.querySelectorAll('.transfer-contact').forEach(function(el) { el.classList.remove('is-hidden'); });
                                                list.querySelectorAll('.transfer-contact-radio').forEach(function(r) { r.checked = false; });
                                            }
                                            if (overlay) { overlay.classList.add('is-open'); overlay.setAttribute('aria-hidden', 'false'); }
                                            function closeTransfer() {
                                                if (overlay) { overlay.classList.remove('is-open'); overlay.setAttribute('aria-hidden', 'true'); }
                                                transferModalContainer.innerHTML = '';
                                            }
                                            if (closeBtn) closeBtn.addEventListener('click', closeTransfer);
                                            if (overlay) overlay.addEventListener('click', function(e) { if (e.target === overlay) closeTransfer(); });
                                            if (list && targetInput) list.querySelectorAll('.transfer-contact-radio').forEach(function(radio) {
                                                radio.addEventListener('change', function() { targetInput.value = this.value; });
                                            });
                                            if (searchInput && list) searchInput.addEventListener('input', function() {
                                                var q = this.value.trim().toLowerCase();
                                                list.querySelectorAll('.transfer-contact').forEach(function(label) {
                                                    var name = label.getAttribute('data-name') || '';
                                                    var email = label.getAttribute('data-email') || '';
                                                    label.classList.toggle('is-hidden', q && name.indexOf(q) === -1 && email.indexOf(q) === -1);
                                                });
                                            });
                                            if (form) form.addEventListener('submit', function(e) {
                                                if (!targetInput || !targetInput.value) { e.preventDefault(); alert('Veuillez choisir une conversation.'); return; }
                                                e.preventDefault();
                                                var fd = new FormData(form);
                                                var targetConvIdVal = targetInput.value;
                                                var sel = list ? list.querySelector('.transfer-contact-radio:checked') : null;
                                                var selectedLabel = sel ? sel.closest('.transfer-contact') : null;
                                                var title = 'Conversation', initials = '?';
                                                if (selectedLabel) {
                                                    var nameEl = selectedLabel.querySelector('.transfer-contact-name');
                                                    var avEl = selectedLabel.querySelector('.transfer-contact-avatar');
                                                    if (nameEl) title = (nameEl.textContent || '').replace(/\s*\(archivée\)\s*$/i, '').trim() || title;
                                                    if (avEl) initials = (avEl.textContent || '').trim().slice(0, 2) || initials;
                                                }
                                                fetch(forwardMessageUrl, { method: 'POST', body: fd, credentials: 'same-origin' })
                                                    .then(function() {
                                                        closeTransfer();
                                                        fetch(sidebarUrl, { credentials: 'same-origin' }).then(function(r) { return r.ok ? r.text() : Promise.reject(); }).then(function(html) {
                                                            content.innerHTML = html;
                                                            loaded = true;
                                                            var url = messengerShowUrlTemplate.replace(/\/0\/?$/, '/' + targetConvIdVal);
                                                            openFloatingChat(url, title, initials);
                                                            var threadsListEl = document.getElementById('threadsList');
                                                            if (threadsListEl && threadsListContentUrl) {
                                                                fetch(threadsListContentUrl + '?archived=0&current=' + encodeURIComponent(targetConvIdVal), { credentials: 'same-origin' })
                                                                    .then(function(r) { return r.ok ? r.text() : Promise.reject(); })
                                                                    .then(function(threadsHtml) { threadsListEl.innerHTML = threadsHtml; })
                                                                    .catch(function() {});
                                                            }
                                                        }).catch(function() {
                                                            var url = messengerShowUrlTemplate.replace(/\/0\/?$/, '/' + targetConvIdVal);
                                                            openFloatingChat(url, title, initials);
                                                        });
                                                    }).catch(function() { alert('Erreur lors du transfert.'); });
                                            });
                                        }).catch(function() { alert('Impossible de charger la liste des conversations.'); });
                                    return;
                                }
                                var signalBtn = ev.target.closest('.dropdown-signal');
                                if (signalBtn) {
                                    ev.preventDefault();
                                    alert('Signaler : fonctionnalité à venir.');
                                    closeFloatPickers();
                                    return;
                                }
                                var a = ev.target.closest('a.dropdown-item[href*="/message/"][href*="/edit"]');
                                if (a) {
                                    ev.preventDefault();
                                    ev.stopPropagation();
                                    var href = a.getAttribute('href');
                                    if (!href) return;
                                    var match = href.match(/\/messenger\/(\d+)\/message\/(\d+)\/edit(?:\?|$)/);
                                    if (!match) return;
                                    closeFloatPickers();
                                    var convIdEdit = match[1], messageId = match[2];
                                    var editFormUrl = '{{ path('app_messenger_edit_message_form', { convId: 0, messageId: 0 }) }}'.replace(/\/0\/message\/0\//, '/' + convIdEdit + '/message/' + messageId + '/');
                                    fetch(editFormUrl, { credentials: 'same-origin' }).then(function(r) { return r.ok ? r.text() : Promise.reject(); }).then(function(html) {
                                        var wrap = floatBody.querySelector('.float-edit-message-wrap');
                                        if (wrap) wrap.remove();
                                        var div = document.createElement('div');
                                        div.innerHTML = html.trim();
                                        var inject = div.firstElementChild;
                                        if (inject) {
                                            var inputArea = floatBody.querySelector('.messenger-float-conversation .message-input-area');
                                            if (inputArea) inputArea.insertAdjacentElement('beforebegin', inject);
                                            var cancelBtn = inject.querySelector('.float-edit-cancel');
                                            if (cancelBtn) cancelBtn.addEventListener('click', function() { inject.remove(); });
                                        }
                                    }).catch(function() {});
                                }
                            });

                            // --- Actions sur les messages en mode réduit (même logique que mode agrandi) ---
                            var transferModalContainer = document.getElementById('messengerFloatTransferModalContainer');
                            var transferModalContentUrl = '{{ path('app_messenger_transfer_modal_content') }}';
                            var forwardMessageUrl = '{{ path('app_messenger_forward_message') }}';
                            var messengerShowUrlTemplate = '{{ path('app_messenger_show', { id: 0 }) }}';
                            var threadsListContentUrl = '{{ path('app_messenger_threads_list_content') }}';
                            var floatDeleteOverlay = document.getElementById('floatDeleteConfirmOverlay');
                            var floatDeleteCancelBtn = document.getElementById('floatDeleteCancel');
                            var floatDeleteSubmitBtn = document.getElementById('floatDeleteSubmit');
                            var pendingDeleteForm = null;

                            function reloadFloatConversation(preserveScroll) {
                                var convEl = floatBody && floatBody.querySelector('.messenger-float-conversation');
                                if (!convEl) return;
                                var convId = convEl.getAttribute('data-conv-id');
                                if (!convId) return;
                                var messagesEl = floatBody.querySelector('.messenger-float-messages');
                                var scrollTop = 0, scrollHeight = 0;
                                if (messagesEl && preserveScroll) {
                                    scrollTop = messagesEl.scrollTop;
                                    scrollHeight = messagesEl.scrollHeight;
                                }
                                var url = '{{ path('app_messenger_float_content', { id: 0 }) }}'.replace('/0/float-content', '/' + convId + '/float-content');
                                fetch(url, { credentials: 'same-origin' }).then(function(r) { return r.text(); }).then(function(html) {
                                    if (floatBody && html) {
                                        updateFloatBodyContent(html, preserveScroll ? { preserveScroll: true, scrollTop: scrollTop, scrollHeight: scrollHeight } : {});
                                    }
                                });
                            }

                            function copyToClipboard(text, done) {
                                if (navigator.clipboard && navigator.clipboard.writeText) {
                                    navigator.clipboard.writeText(text).then(function() { if (done) done(); }).catch(function() { if (done) done(); });
                                } else {
                                    var ta = document.createElement('textarea'); ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); if (done) done();
                                }
                            }

                            var dropdownPortal = document.getElementById('messengerFloatDropdownPortal');
                            var lastPortalTrigger = null;

                            function closeFloatPickers() {
                                if (!floatBody) return;
                                floatBody.querySelectorAll('.emoji-picker.is-open').forEach(function(p) { p.classList.remove('is-open'); });
                                floatBody.querySelectorAll('.kebab-dropdown.is-open').forEach(function(p) { p.classList.remove('is-open'); });
                                if (dropdownPortal) dropdownPortal.innerHTML = '';
                                lastPortalTrigger = null;
                            }

                            function openInPortal(node, anchorRect, preferAbove, triggerEl) {
                                if (!dropdownPortal || !node) return;
                                if (triggerEl && dropdownPortal.children.length > 0 && lastPortalTrigger === triggerEl) {
                                    closeFloatPickers();
                                    return;
                                }
                                closeFloatPickers();
                                lastPortalTrigger = triggerEl || null;
                                var clone = node.cloneNode(true);
                                clone.classList.add('is-open');
                                var wrap = document.createElement('div');
                                wrap.className = 'messenger-float-portal-wrap';
                                wrap.style.position = 'fixed';
                                wrap.style.zIndex = '10002';
                                wrap.style.pointerEvents = 'auto';
                                wrap.style.left = (anchorRect.right - 200) + 'px';
                                wrap.style.top = (anchorRect.top - 280) + 'px';
                                wrap.appendChild(clone);
                                dropdownPortal.appendChild(wrap);
                                var pad = 8;
                                var viewH = window.innerHeight;
                                var viewW = window.innerWidth;
                                requestAnimationFrame(function() {
                                    var h = wrap.offsetHeight;
                                    var w = wrap.offsetWidth;
                                    var top;
                                    if (preferAbove !== false) {
                                        top = anchorRect.top - h - pad;
                                        if (top < 8) top = pad;
                                    } else {
                                        top = anchorRect.bottom + pad;
                                        if (top + h > viewH - 8) top = anchorRect.top - h - pad;
                                    }
                                    var left = anchorRect.right - w;
                                    if (left < 8) left = 8;
                                    if (left + w > viewW - 8) left = viewW - w - 8;
                                    wrap.style.top = top + 'px';
                                    wrap.style.left = left + 'px';
                                });
                            }

                            document.addEventListener('click', function(e) {
                                if (dropdownPortal && dropdownPortal.contains(e.target)) return;
                                if (floatBody && floatBody.contains(e.target) && (e.target.closest('.message-actions') || e.target.closest('.emoji-picker') || e.target.closest('.kebab-dropdown'))) return;
                                closeFloatPickers();
                            });

                            // Annuler la réponse en mode réduit : délégation au document (capture) pour intercepter le clic
                            document.addEventListener('click', function(e) {
                                var cancelBtn = e.target && e.target.closest && e.target.closest('.reply-preview-cancel');
                                if (!cancelBtn || !floatBody || !floatBody.contains(cancelBtn)) return;
                                e.preventDefault();
                                e.stopPropagation();
                                var replyToInput = floatBody.querySelector('#replyToInput');
                                var replyPreviewBar = floatBody.querySelector('#replyPreviewBar');
                                var replyPreviewText = floatBody.querySelector('#replyPreviewText');
                                if (replyToInput) replyToInput.value = '';
                                if (replyPreviewBar) replyPreviewBar.classList.remove('is-visible');
                                if (replyPreviewText) replyPreviewText.textContent = '';
                            }, true);

                            if (floatBody) {
                                floatBody.addEventListener('click', function(e) {
                                    var target = e.target;
                                    var kebabBtn = target.closest('.kebab-btn');
                                    var emojiBtn = target.closest('.message-action-btn.emoji-btn');
                                    var copyBtn = target.closest('.dropdown-copy');
                                    var transferBtn = target.closest('.dropdown-transfer');
                                    var convEl = floatBody.querySelector('.messenger-float-conversation');
                                    var convId = convEl ? convEl.getAttribute('data-conv-id') : '';

                                    if (kebabBtn) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        var wrap = kebabBtn.closest('.kebab-wrap');
                                        var dropdown = wrap ? wrap.querySelector('.kebab-dropdown') : null;
                                        if (dropdown) {
                                            var rect = wrap.getBoundingClientRect();
                                            openInPortal(dropdown, rect, true, wrap);
                                        }
                                        return;
                                    }
                                    if (emojiBtn && !target.closest('.emoji-picker')) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        var picker = emojiBtn.querySelector('.emoji-picker');
                                        if (picker) {
                                            var rect = emojiBtn.getBoundingClientRect();
                                            openInPortal(picker, rect, true, emojiBtn);
                                        }
                                        return;
                                    }
                                    if (copyBtn) {
                                        e.preventDefault();
                                        var text = copyBtn.getAttribute('data-copy-text') || '';
                                        copyToClipboard(text, function() {
                                            var orig = copyBtn.innerHTML;
                                            copyBtn.innerHTML = '<i class="fas fa-check" style="margin-right:8px;width:16px;"></i>Copié !';
                                            setTimeout(function() { copyBtn.innerHTML = orig; }, 1500);
                                        });
                                        closeFloatPickers();
                                        return;
                                    }
                                    if (transferBtn && convId) {
                                        e.preventDefault();
                                        var msgId = transferBtn.getAttribute('data-transfer-msg-id');
                                        if (!msgId) return;
                                        closeFloatPickers();
                                        fetch(transferModalContentUrl + '?exclude=' + encodeURIComponent(convId), { credentials: 'same-origin' })
                                            .then(function(r) { return r.text(); })
                                            .then(function(html) {
                                                if (!transferModalContainer) return;
                                                transferModalContainer.innerHTML = html;
                                                var overlay = transferModalContainer.querySelector('.transfer-modal-overlay');
                                                var msgInput = transferModalContainer.querySelector('#transferMessageId');
                                                var targetInput = transferModalContainer.querySelector('#transferTargetConvId');
                                                var form = transferModalContainer.querySelector('#transferForm');
                                                var closeBtn = transferModalContainer.querySelector('#transferModalClose');
                                                var searchInput = transferModalContainer.querySelector('#transferSearch');
                                                var list = transferModalContainer.querySelector('#transferList');
                                                if (msgInput) msgInput.value = msgId;
                                                if (targetInput) targetInput.value = '';
                                                if (searchInput) searchInput.value = '';
                                                if (list) {
                                                    list.querySelectorAll('.transfer-contact').forEach(function(el) { el.classList.remove('is-hidden'); });
                                                    list.querySelectorAll('.transfer-contact-radio').forEach(function(r) { r.checked = false; });
                                                }
                                                if (overlay) { overlay.classList.add('is-open'); overlay.setAttribute('aria-hidden', 'false'); }
                                                function closeTransfer() {
                                                    if (overlay) { overlay.classList.remove('is-open'); overlay.setAttribute('aria-hidden', 'true'); }
                                                    transferModalContainer.innerHTML = '';
                                                }
                                                if (closeBtn) closeBtn.addEventListener('click', closeTransfer);
                                                if (overlay) overlay.addEventListener('click', function(ev) { if (ev.target === overlay) closeTransfer(); });
                                                if (list && targetInput) {
                                                    list.querySelectorAll('.transfer-contact-radio').forEach(function(radio) {
                                                        radio.addEventListener('change', function() { targetInput.value = this.value; });
                                                    });
                                                }
                                                if (searchInput && list) {
                                                    searchInput.addEventListener('input', function() {
                                                        var q = this.value.trim().toLowerCase();
                                                        list.querySelectorAll('.transfer-contact').forEach(function(label) {
                                                            var name = label.getAttribute('data-name') || '';
                                                            var email = label.getAttribute('data-email') || '';
                                                            label.classList.toggle('is-hidden', q && name.indexOf(q) === -1 && email.indexOf(q) === -1);
                                                        });
                                                    });
                                                }
                                                if (form) {
                                                    form.addEventListener('submit', function(ev) {
                                                        if (!targetInput || !targetInput.value) { ev.preventDefault(); alert('Veuillez choisir une conversation.'); return; }
                                                        ev.preventDefault();
                                                        var fd = new FormData(form);
                                                        var targetConvIdVal = targetInput.value;
                                                        var sel = list ? list.querySelector('.transfer-contact-radio:checked') : null;
                                                        var selectedLabel = sel ? sel.closest('.transfer-contact') : null;
                                                        var title = 'Conversation', initials = '?';
                                                        if (selectedLabel) {
                                                            var nameEl = selectedLabel.querySelector('.transfer-contact-name');
                                                            var avEl = selectedLabel.querySelector('.transfer-contact-avatar');
                                                            if (nameEl) title = (nameEl.textContent || '').replace(/\s*\(archivée\)\s*$/i, '').trim() || title;
                                                            if (avEl) initials = (avEl.textContent || '').trim().slice(0, 2) || initials;
                                                        }
                                                        fetch(forwardMessageUrl, { method: 'POST', body: fd, credentials: 'same-origin' })
                                                            .then(function() {
                                                                closeTransfer();
                                                                fetch(sidebarUrl, { credentials: 'same-origin' }).then(function(r) { return r.ok ? r.text() : Promise.reject(); }).then(function(html) {
                                                                    content.innerHTML = html;
                                                                    loaded = true;
                                                                    var url = messengerShowUrlTemplate.replace(/\/0\/?$/, '/' + targetConvIdVal);
                                                                    openFloatingChat(url, title, initials);
                                                                    var threadsListEl = document.getElementById('threadsList');
                                                                    if (threadsListEl && threadsListContentUrl) {
                                                                        fetch(threadsListContentUrl + '?archived=0&current=' + encodeURIComponent(targetConvIdVal), { credentials: 'same-origin' })
                                                                            .then(function(r) { return r.ok ? r.text() : Promise.reject(); })
                                                                            .then(function(threadsHtml) { threadsListEl.innerHTML = threadsHtml; })
                                                                            .catch(function() {});
                                                                    }
                                                                }).catch(function() {
                                                                    var url = messengerShowUrlTemplate.replace(/\/0\/?$/, '/' + targetConvIdVal);
                                                                    openFloatingChat(url, title, initials);
                                                                });
                                                            })
                                                            .catch(function() { alert('Erreur lors du transfert.'); });
                                                    });
                                                }
                                            })
                                            .catch(function() { alert('Impossible de charger la liste des conversations.'); });
                                        return;
                                    }

                                    var signalBtn = target.closest('.dropdown-signal');
                                    if (signalBtn) {
                                        e.preventDefault();
                                        alert('Signaler : fonctionnalité à venir.');
                                        closeFloatPickers();
                                        return;
                                    }

                                    var editLink = target.closest('a.dropdown-item[href*="/message/"][href*="/edit"]');
                                    if (editLink) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        var href = editLink.getAttribute('href');
                                        if (!href) return;
                                        var match = href.match(/\/messenger\/(\d+)\/message\/(\d+)\/edit(?:\?|$)/);
                                        if (!match) return;
                                        var convId = match[1];
                                        var messageId = match[2];
                                        closeFloatPickers();
                                        var editFormUrl = '{{ path('app_messenger_edit_message_form', { convId: 0, messageId: 0 }) }}'.replace(/\/0\/message\/0\//, '/' + convId + '/message/' + messageId + '/');
                                        fetch(editFormUrl, { credentials: 'same-origin' })
                                            .then(function(r) { return r.ok ? r.text() : Promise.reject(); })
                                            .then(function(html) {
                                                var wrap = floatBody.querySelector('.float-edit-message-wrap');
                                                if (wrap) wrap.remove();
                                                var div = document.createElement('div');
                                                div.innerHTML = html.trim();
                                                var inject = div.firstElementChild;
                                                if (inject) {
                                                    var inputArea = floatBody.querySelector('.messenger-float-conversation .message-input-area');
                                                    if (inputArea) inputArea.insertAdjacentElement('beforebegin', inject);
                                                    var cancelBtn = inject.querySelector('.float-edit-cancel');
                                                    if (cancelBtn) cancelBtn.addEventListener('click', function() { inject.remove(); });
                                                }
                                            })
                                            .catch(function() {});
                                        return;
                                    }

                                    var replyCancelBtn = target.closest('.reply-preview-cancel');
                                    if (replyCancelBtn && floatBody.contains(replyCancelBtn)) {
                                        e.preventDefault();
                                        var replyToInput = floatBody.querySelector('#replyToInput');
                                        var replyPreviewBar = floatBody.querySelector('#replyPreviewBar');
                                        var replyPreviewText = floatBody.querySelector('#replyPreviewText');
                                        if (replyToInput && replyPreviewBar && replyPreviewText) {
                                            replyToInput.value = '';
                                            replyPreviewBar.classList.remove('is-visible');
                                            replyPreviewText.textContent = '';
                                        }
                                        return;
                                    }

                                    var replyBtn = target.closest('.msg-reply');
                                    if (replyBtn) {
                                        e.preventDefault();
                                        var replyToInput = floatBody.querySelector('#replyToInput');
                                        var replyPreviewBar = floatBody.querySelector('#replyPreviewBar');
                                        var replyPreviewText = floatBody.querySelector('#replyPreviewText');
                                        if (replyToInput && replyPreviewBar && replyPreviewText) {
                                            replyToInput.value = replyBtn.getAttribute('data-reply-id') || '';
                                            replyPreviewText.textContent = 'Réponse à ' + (replyBtn.getAttribute('data-reply-author') || '') + ': ' + (replyBtn.getAttribute('data-reply-text') || '');
                                            replyPreviewBar.classList.add('is-visible');
                                            var msgInput = floatBody.querySelector('#messageInput');
                                            if (msgInput) msgInput.focus();
                                        }
                                        closeFloatPickers();
                                    }
                                });
                            }

                            if (floatDeleteCancelBtn) floatDeleteCancelBtn.addEventListener('click', function() {
                                pendingDeleteForm = null;
                                if (floatDeleteOverlay) { floatDeleteOverlay.classList.remove('is-open'); floatDeleteOverlay.setAttribute('aria-hidden', 'true'); }
                                closeFloatPickers();
                            });
                            if (floatDeleteSubmitBtn) floatDeleteSubmitBtn.addEventListener('click', function() {
                                if (!pendingDeleteForm) return;
                                var form = pendingDeleteForm;
                                var actionUrl = form.getAttribute('action');
                                var fd = new FormData(form);
                                pendingDeleteForm = null;
                                if (floatDeleteOverlay) floatDeleteOverlay.classList.remove('is-open');
                                closeFloatPickers();
                                fetch(actionUrl, { method: 'POST', body: fd, credentials: 'same-origin' })
                                    .then(function() { reloadFloatConversation(true); })
                                    .catch(function() { reloadFloatConversation(true); });
                            });
                            if (floatDeleteOverlay) floatDeleteOverlay.addEventListener('click', function(e) {
                                if (e.target === floatDeleteOverlay) {
                                    pendingDeleteForm = null;
                                    floatDeleteOverlay.classList.remove('is-open');
                                }
                            });

                            if (btn) btn.addEventListener('click', function() {
                                if (floatRoot && floatRoot.classList.contains('is-open')) closeFloatingChat();
                                if (sidebar && sidebar.classList.contains('is-open')) closeSidebar();
                                else openSidebar();
                            });
                            if (closeBtn) closeBtn.addEventListener('click', closeSidebar);
                            var profileBtn = document.getElementById('userProfileBtn');
                            if (profileBtn) profileBtn.addEventListener('click', closeSidebar);

                            // Filtrage de la liste des conversations par la barre de recherche (respecte l'onglet actif)
                            if (sidebar) sidebar.addEventListener('input', function(e) {
                                if (e.target.id !== 'navbarChatSidebarListSearch') return;
                                var q = (e.target.value || '').trim().toLowerCase();
                                var threadsEl = document.getElementById('navbarChatSidebarThreads');
                                if (!threadsEl) return;
                                var activeTab = sidebar.querySelector('.navbar-chat-sidebar-tab.active');
                                var filter = activeTab ? activeTab.getAttribute('data-tab') : 'all';
                                var wraps = threadsEl.querySelectorAll('.navbar-chat-sidebar-thread-wrap');
                                wraps.forEach(function(w) {
                                    var isGroup = w.getAttribute('data-is-group') === '1';
                                    var unread = w.getAttribute('data-unread') === '1';
                                    var tabMatch = (filter === 'all') || (filter === 'groups' && isGroup) || (filter === 'unread' && unread);
                                    var userEl = w.querySelector('.thread-user');
                                    var previewEl = w.querySelector('.thread-preview');
                                    var text = ((userEl ? userEl.textContent : '') + ' ' + (previewEl ? previewEl.textContent : '')).toLowerCase();
                                    var searchMatch = q === '' || text.indexOf(q) !== -1;
                                    w.style.display = (tabMatch && searchMatch) ? '' : 'none';
                                });
                            });

                            // Délégation : onglets et menu 3 points (contenu chargé dynamiquement)
                            if (sidebar) sidebar.addEventListener('click', function(e) {
                                var tab = e.target.closest('.navbar-chat-sidebar-tab');
                                var menuBtn = e.target.closest('.navbar-chat-sidebar-menu-btn');
                                var threadsEl = document.getElementById('navbarChatSidebarThreads');
                                if (tab && threadsEl) {
                                    tab.parentElement.querySelectorAll('.navbar-chat-sidebar-tab').forEach(function(t) { t.classList.remove('active'); t.setAttribute('aria-pressed', 'false'); });
                                    tab.classList.add('active');
                                    tab.setAttribute('aria-pressed', 'true');
                                    var filter = tab.getAttribute('data-tab');
                                    var searchInput = document.getElementById('navbarChatSidebarListSearch');
                                    var q = (searchInput && searchInput.value) ? searchInput.value.trim().toLowerCase() : '';
                                    var wraps = threadsEl.querySelectorAll('.navbar-chat-sidebar-thread-wrap');
                                    wraps.forEach(function(w) {
                                        var isGroup = w.getAttribute('data-is-group') === '1';
                                        var unread = w.getAttribute('data-unread') === '1';
                                        var tabMatch = (filter === 'all') || (filter === 'groups' && isGroup) || (filter === 'unread' && unread);
                                        var userEl = w.querySelector('.thread-user');
                                        var previewEl = w.querySelector('.thread-preview');
                                        var text = ((userEl ? userEl.textContent : '') + ' ' + (previewEl ? previewEl.textContent : '')).toLowerCase();
                                        var searchMatch = q === '' || text.indexOf(q) !== -1;
                                        w.style.display = (tabMatch && searchMatch) ? '' : 'none';
                                    });
                                }
                                if (menuBtn) {
                                    var drop = document.getElementById('navbarChatSidebarMenuDropdown');
                                    if (drop) {
                                        drop.classList.toggle('is-open');
                                        drop.setAttribute('aria-hidden', drop.classList.contains('is-open') ? 'false' : 'true');
                                        menuBtn.setAttribute('aria-expanded', drop.classList.contains('is-open'));
                                    }
                                }
                            });
                            document.addEventListener('click', function(e) {
                                var drop = document.getElementById('navbarChatSidebarMenuDropdown');
                                var menuWrap = document.querySelector('.navbar-chat-sidebar-menu-wrap');
                                if (drop && menuWrap && !menuWrap.contains(e.target)) {
                                    drop.classList.remove('is-open');
                                    drop.setAttribute('aria-hidden', 'true');
                                    var menuBtn = document.getElementById('navbarChatSidebarMenuBtn');
                                    if (menuBtn) menuBtn.setAttribute('aria-expanded', 'false');
                                }
                            });
                        })();
                    </script>
                    {% else %}
                    <!-- Login/Register Buttons -->
                    <a href="/login" class="btn btn-secondary">Login</a>
                    <a href="/register" class="btn btn-primary">Join Now</a>
                    {% endif %}
                    
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>
